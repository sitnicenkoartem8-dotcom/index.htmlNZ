<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ù–æ–≤–∞—è –ó–µ–º–ª—è ‚Äî –ò–≥—Ä–∞ –ø–ª–µ–º—ë–Ω</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', system-ui, sans-serif; }
    
    :root {
      --primary: #10b981;
      --primary-dark: #059669;
      --secondary: #6366f1;
      --accent: #f59e0b;
      --bg-dark: #0a0f1a;
      --bg-card: rgba(15, 23, 42, 0.8);
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    body {
      background: linear-gradient(135deg, #0a0f1a 0%, #1a1f35 50%, #0d1525 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .bg-animated {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }

    .bg-animated::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 20% 50%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 40% 80%, rgba(245, 158, 11, 0.08) 0%, transparent 50%);
      animation: bgFloat 20s ease-in-out infinite;
    }

    @keyframes bgFloat {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(2%, 2%) rotate(1deg); }
      66% { transform: translate(-1%, 1%) rotate(-1deg); }
    }

    .glass-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.1);
    }

    .glass-card:hover {
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.15);
    }

    .gradient-text {
      background: linear-gradient(135deg, #10b981, #6366f1, #f59e0b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .btn-primary {
      background: linear-gradient(135deg, #10b981, #059669);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn-primary:hover::before { left: 100%; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4); }

    .btn-secondary {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(99, 102, 241, 0.1));
      border: 1px solid rgba(99, 102, 241, 0.3);
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(99, 102, 241, 0.2));
      border-color: rgba(99, 102, 241, 0.5);
      transform: translateY(-2px);
    }

    .btn-danger {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
      border: 1px solid rgba(239, 68, 68, 0.3);
      transition: all 0.3s ease;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0.2));
      border-color: rgba(239, 68, 68, 0.5);
    }

    .nav-link {
      position: relative;
      transition: all 0.3s ease;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      width: 0;
      height: 2px;
      background: linear-gradient(90deg, #10b981, #6366f1);
      transition: all 0.3s ease;
      transform: translateX(-50%);
    }

    .nav-link:hover::after, .nav-link.active::after { width: 100%; }
    .nav-link.active { color: #10b981; }

    .page-section {
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.5s ease;
      display: none;
    }

    .page-section.active {
      opacity: 1;
      transform: translateY(0);
      display: block;
    }

    .tribe-card {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .tribe-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #10b981, #6366f1, #f59e0b);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .tribe-card:hover::before { opacity: 1; }
    .tribe-card:hover { transform: translateY(-8px) scale(1.02); }

    .accordion-item { transition: all 0.3s ease; }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), padding 0.3s ease;
    }

    .accordion-content.open { max-height: 2000px; }

    .accordion-header {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .accordion-header:hover { background: rgba(255, 255, 255, 0.05); }

    .accordion-icon { transition: transform 0.3s ease; }

    .accordion-item.open .accordion-icon { transform: rotate(180deg); }

    .stat-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    .stat-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 1s ease;
    }

    .top-table tr { transition: all 0.3s ease; }
    .top-table tr:hover { background: rgba(255, 255, 255, 0.05); }

    .rank-badge {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
    }

    .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1a1a1a; }
    .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: #1a1a1a; }
    .rank-3 { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));
      color: white;
      font-weight: 500;
      transform: translateX(400px);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    .toast.show { transform: translateX(0); opacity: 1; }
    .toast.error { background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9)); }

    .modal-backdrop {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-backdrop.show { opacity: 1; }

    .modal-content {
      transform: scale(0.9) translateY(20px);
      opacity: 0;
      transition: all 0.3s ease;
    }

    .modal-backdrop.show .modal-content {
      transform: scale(1) translateY(0);
      opacity: 1;
    }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

    .race-card {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .race-card:hover {
      transform: translateY(-4px);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .race-icon {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      flex-shrink: 0;
    }

    .buff { color: #10b981; }
    .debuff { color: #ef4444; }

    .status-toggle {
      position: relative;
      width: 50px;
      height: 26px;
      background: rgba(239, 68, 68, 0.3);
      border-radius: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(239, 68, 68, 0.5);
    }

    .status-toggle.active {
      background: rgba(16, 185, 129, 0.3);
      border-color: rgba(16, 185, 129, 0.5);
    }

    .status-toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      background: #ef4444;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .status-toggle.active::after {
      left: 27px;
      background: #10b981;
    }

    .delete-rule-btn {
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .accordion-header:hover .delete-rule-btn {
      opacity: 1;
    }
  </style>
</head>
<body class="text-white">
  <div class="bg-animated"></div>

  <!-- Header -->
  <header class="fixed top-0 left-0 right-0 z-50 glass-card border-0 border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-indigo-600 flex items-center justify-center font-bold text-lg shadow-lg">NZ</div>
          <div>
            <h1 class="font-bold text-lg leading-tight">–ù–æ–≤–∞—è –ó–µ–º–ª—è</h1>
            <p class="text-xs text-gray-400">–ò–≥—Ä–∞ –ø–ª–µ–º—ë–Ω</p>
          </div>
        </div>

        <nav class="hidden lg:flex items-center gap-4">
          <button onclick="showPage('welcome')" class="nav-link active text-sm font-medium text-gray-300 hover:text-white px-2 py-1" data-page="welcome">–ì–ª–∞–≤–Ω–∞—è</button>
          <button onclick="showPage('map')" class="nav-link text-sm font-medium text-gray-300 hover:text-white px-2 py-1" data-page="map">–ö–∞—Ä—Ç–∞</button>
          <button onclick="showPage('tribes')" class="nav-link text-sm font-medium text-gray-300 hover:text-white px-2 py-1" data-page="tribes">–ü–ª–µ–º–µ–Ω–∞</button>
          <button onclick="showPage('tops')" class="nav-link text-sm font-medium text-gray-300 hover:text-white px-2 py-1" data-page="tops">–¢–æ–ø—ã</button>
          <button onclick="showPage('races')" class="nav-link text-sm font-medium text-gray-300 hover:text-white px-2 py-1" data-page="races">üåç –†–∞—Å—ã</button>
          <button onclick="showPage('explain')" class="nav-link text-sm font-medium text-gray-300 hover:text-white px-2 py-1" data-page="explain">–û–±—ä—è—Å–Ω–µ–Ω–∏–µ</button>
        </nav>

        <div class="flex items-center gap-3">
          <div id="roleBadge" class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-xs font-medium">
            <span class="w-2 h-2 rounded-full bg-gray-500"></span>
            <span>–ì–æ—Å—Ç—å</span>
          </div>
          <button id="loginBtn" onclick="openLoginModal()" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">–í–æ–π—Ç–∏</button>
          <button id="logoutBtn" onclick="logout()" class="hidden btn-secondary px-4 py-2 rounded-lg text-sm font-medium">–í—ã–π—Ç–∏</button>
        </div>

        <button onclick="toggleMobileMenu()" class="lg:hidden p-2 rounded-lg hover:bg-white/10">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
      </div>
    </div>

    <div id="mobileMenu" class="hidden lg:hidden border-t border-white/10 bg-black/50 backdrop-blur-xl">
      <div class="px-4 py-4 space-y-2">
        <button onclick="showPage('welcome'); toggleMobileMenu()" class="block w-full text-left px-4 py-2 rounded-lg hover:bg-white/10 text-sm">–ì–ª–∞–≤–Ω–∞—è</button>
        <button onclick="showPage('map'); toggleMobileMenu()" class="block w-full text-left px-4 py-2 rounded-lg hover:bg-white/10 text-sm">–ö–∞—Ä—Ç–∞</button>
        <button onclick="showPage('tribes'); toggleMobileMenu()" class="block w-full text-left px-4 py-2 rounded-lg hover:bg-white/10 text-sm">–ü–ª–µ–º–µ–Ω–∞</button>
        <button onclick="showPage('tops'); toggleMobileMenu()" class="block w-full text-left px-4 py-2 rounded-lg hover:bg-white/10 text-sm">–¢–æ–ø—ã</button>
        <button onclick="showPage('races'); toggleMobileMenu()" class="block w-full text-left px-4 py-2 rounded-lg hover:bg-white/10 text-sm">üåç –†–∞—Å—ã –∏ –±–∏–æ–º—ã</button>
        <button onclick="showPage('explain'); toggleMobileMenu()" class="block w-full text-left px-4 py-2 rounded-lg hover:bg-white/10 text-sm">–û–±—ä—è—Å–Ω–µ–Ω–∏–µ</button>
      </div>
    </div>
  </header>

  <main class="pt-20 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
    
    <!-- Welcome Page -->
    <section id="page-welcome" class="page-section active">
      <div class="relative overflow-hidden rounded-3xl glass-card p-8 sm:p-12 mb-8">
        <div class="absolute top-0 right-0 w-96 h-96 bg-gradient-to-br from-emerald-500/20 to-indigo-600/20 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
        
        <div class="relative">
          <!-- Game Status Badge -->
          <div class="flex items-center gap-3 mb-6">
            <div id="gameStatusBadge" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-sm font-medium">
              <span id="gameStatusDot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
              <span id="gameStatusText">–ò–≥—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
            </div>
            
            <!-- Admin toggle for game status -->
            <div id="gameStatusToggle" class="hidden flex items-center gap-2">
              <div class="status-toggle active" onclick="toggleGameStatus()" id="statusToggleBtn"></div>
              <span class="text-xs text-gray-400">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º</span>
            </div>
          </div>
          
          <h1 class="text-4xl sm:text-5xl lg:text-6xl font-black mb-6">
            <span class="gradient-text">–ù–æ–≤–∞—è –ó–µ–º–ª—è</span>
          </h1>
          
          <p class="text-lg sm:text-xl text-gray-300 max-w-2xl mb-8 leading-relaxed">
            –°–æ–∑–¥–∞–≤–∞–π –ø–ª–µ–º—è, —É–ø—Ä–∞–≤–ª—è–π —ç–Ω–µ—Ä–≥–∏–µ–π, —Ä–∞—Å—à–∏—Ä—è–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –∏ —Å—Ä–∞–∂–∞–π—Å—è –∑–∞ –≥–æ—Å–ø–æ–¥—Å—Ç–≤–æ –Ω–∞ –∫–∞—Ä—Ç–µ! 
            –ò–≥—Ä–∞ –≤–µ–¥—ë—Ç—Å—è –≤ Telegram ‚Äî –∑–¥–µ—Å—å —Ç—ã –Ω–∞–π–¥—ë—à—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É, –ø—Ä–∞–≤–∏–ª–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.
          </p>

          <div class="flex flex-wrap gap-4">
            <button onclick="showPage('explain')" class="btn-primary px-6 py-3 rounded-xl font-semibold text-white">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å?</button>
            <button onclick="showPage('map')" class="btn-secondary px-6 py-3 rounded-xl font-semibold">–°–º–æ—Ç—Ä–µ—Ç—å –∫–∞—Ä—Ç—É</button>
            <button onclick="showPage('races')" class="btn-secondary px-6 py-3 rounded-xl font-semibold">üåç –†–∞—Å—ã –∏ –±–∏–æ–º—ã</button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
        <div class="glass-card rounded-2xl p-6 text-center">
          <div class="text-3xl font-bold gradient-text" id="stat-tribes">0</div>
          <div class="text-sm text-gray-400 mt-1">–ü–ª–µ–º—ë–Ω</div>
        </div>
        <div class="glass-card rounded-2xl p-6 text-center">
          <div class="text-3xl font-bold text-emerald-400" id="stat-population">0</div>
          <div class="text-sm text-gray-400 mt-1">–ù–∞—Å–µ–ª–µ–Ω–∏–µ</div>
        </div>
        <div class="glass-card rounded-2xl p-6 text-center">
          <div class="text-3xl font-bold text-indigo-400" id="stat-territories">0</div>
          <div class="text-sm text-gray-400 mt-1">–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π</div>
        </div>
        <div class="glass-card rounded-2xl p-6 text-center">
          <div class="text-3xl font-bold text-amber-400" id="stat-army">0</div>
          <div class="text-sm text-gray-400 mt-1">–í–æ–∏–Ω–æ–≤</div>
        </div>
      </div>

      <div class="glass-card rounded-2xl p-6 sm:p-8 mb-8">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
          <span class="text-3xl">üÜï</span>
          –î–ª—è –Ω–æ–≤–∏—á–∫–æ–≤
        </h2>
        <div class="grid sm:grid-cols-2 lg:grid-cols-5 gap-4">
          <div class="flex items-start gap-3 p-4 rounded-xl bg-white/5">
            <span class="text-2xl">üè∑</span>
            <div>
              <div class="font-semibold">1. –ù–∞–∑–≤–∞–Ω–∏–µ</div>
              <div class="text-sm text-gray-400">–ü—Ä–∏–¥—É–º–∞–π –∏–º—è —Å–≤–æ–µ–π —Å—Ç—Ä–∞–Ω–µ</div>
            </div>
          </div>
          <div class="flex items-start gap-3 p-4 rounded-xl bg-white/5">
            <span class="text-2xl">üé®</span>
            <div>
              <div class="font-semibold">2. –§–ª–∞–≥</div>
              <div class="text-sm text-gray-400">–°–æ–∑–¥–∞–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥</div>
            </div>
          </div>
          <div class="flex items-start gap-3 p-4 rounded-xl bg-white/5">
            <span class="text-2xl">üèõ</span>
            <div>
              <div class="font-semibold">3. –°—Ç–æ–ª–∏—Ü–∞</div>
              <div class="text-sm text-gray-400">–ù–∞–∑–æ–≤–∏ —Å–≤–æ—é —Å—Ç–æ–ª–∏—Ü—É</div>
            </div>
          </div>
          <div class="flex items-start gap-3 p-4 rounded-xl bg-white/5">
            <span class="text-2xl">üìç</span>
            <div>
              <div class="font-semibold">4. –õ–æ–∫–∞—Ü–∏—è</div>
              <div class="text-sm text-gray-400">–í—ã–±–µ—Ä–∏ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ</div>
            </div>
          </div>
          <div class="flex items-start gap-3 p-4 rounded-xl bg-white/5">
            <span class="text-2xl">üó∫</span>
            <div>
              <div class="font-semibold">5. –°—Ç–∞—Ä—Ç!</div>
              <div class="text-sm text-gray-400">–¢–µ–±—è –¥–æ–±–∞–≤—è—Ç –Ω–∞ –∫–∞—Ä—Ç—É</div>
            </div>
          </div>
        </div>
        
        <div class="mt-6 p-4 rounded-xl bg-gradient-to-r from-emerald-500/10 to-indigo-500/10 border border-emerald-500/20">
          <div class="flex items-center gap-3">
            <span class="text-2xl">‚ö°Ô∏è</span>
            <div>
              <span class="font-semibold">–ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç</span> –ø–ª–µ–º—è –ø–æ–ª—É—á–∞–µ—Ç <span class="text-emerald-400 font-bold">+15 —ç–Ω–µ—Ä–≥–∏–∏</span>. 
              –ú–∞–∫—Å–∏–º—É–º ‚Äî <span class="text-amber-400 font-bold">100 ‚ö°Ô∏è</span>
            </div>
          </div>
        </div>
      </div>

      <div class="glass-card rounded-2xl p-6 sm:p-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">üèÜ –õ–∏–¥–µ—Ä—ã</h2>
          <button onclick="showPage('tops')" class="text-sm text-emerald-400 hover:text-emerald-300 font-medium">–í—Å–µ —Ç–æ–ø—ã ‚Üí</button>
        </div>
        <div id="leadersPreview" class="grid sm:grid-cols-3 gap-4"></div>
      </div>
    </section>

    <!-- Map Page -->
    <section id="page-map" class="page-section">
      <div class="glass-card rounded-2xl p-6 sm:p-8">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
          <div>
            <h2 class="text-2xl font-bold mb-1">üó∫ –ö–∞—Ä—Ç–∞ –º–∏—Ä–∞</h2>
            <p class="text-gray-400">–ê–∫—Ç—É–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –ù–æ–≤–æ–π –ó–µ–º–ª–∏</p>
          </div>
          <div id="mapControls" class="hidden flex-wrap gap-2">
            <label class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium cursor-pointer">
              üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É
              <input type="file" id="mapUpload" accept="image/*" class="hidden">
            </label>
            <button onclick="resetMap()" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">üóë –°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>

        <div id="mapContainer" class="relative rounded-xl overflow-hidden bg-black/30 min-h-[300px] flex items-center justify-center">
          <div id="mapPlaceholder" class="text-center p-8">
            <div class="text-6xl mb-4">üó∫</div>
            <p class="text-gray-400">–ö–∞—Ä—Ç–∞ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</p>
            <p class="text-sm text-gray-500 mt-2">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É</p>
          </div>
          <img id="mapImage" src="" alt="–ö–∞—Ä—Ç–∞ –ù–æ–≤–æ–π –ó–µ–º–ª–∏" class="hidden w-full h-auto rounded-xl">
        </div>
        
        <div class="mt-4 text-sm text-gray-500 text-center">
          –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="mapLastUpdate">‚Äî</span>
        </div>
      </div>
    </section>

    <!-- Tribes Page -->
    <section id="page-tribes" class="page-section">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
        <div>
          <h2 class="text-2xl font-bold mb-1">üè∞ –ü–ª–µ–º–µ–Ω–∞</h2>
          <p class="text-gray-400">–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–µ–º–µ–Ω–∞ –Ω–∞ –∫–∞—Ä—Ç–µ</p>
        </div>
        <div id="tribeControls" class="hidden">
          <button onclick="openAddTribeModal()" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium">+ –î–æ–±–∞–≤–∏—Ç—å –ø–ª–µ–º—è</button>
        </div>
      </div>

      <div id="tribesGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <!-- Tops Page -->
    <section id="page-tops" class="page-section">
      <h2 class="text-2xl font-bold mb-6">üèÜ –†–µ–π—Ç–∏–Ω–≥–∏ –ø–ª–µ–º—ë–Ω</h2>
      
      <div class="grid lg:grid-cols-2 gap-6">
        <div class="glass-card rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-2xl">‚öîÔ∏è</span>
            <h3 class="text-xl font-bold">–ü–æ –∞—Ä–º–∏–∏</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full top-table">
              <thead>
                <tr class="text-left text-gray-400 text-sm">
                  <th class="pb-3 w-12">#</th>
                  <th class="pb-3">–ü–ª–µ–º—è</th>
                  <th class="pb-3 text-right">–ê—Ä–º–∏—è</th>
                </tr>
              </thead>
              <tbody id="topArmy" class="text-sm"></tbody>
            </table>
          </div>
        </div>

        <div class="glass-card rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-2xl">üë•</span>
            <h3 class="text-xl font-bold">–ü–æ –Ω–∞—Å–µ–ª–µ–Ω–∏—é</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full top-table">
              <thead>
                <tr class="text-left text-gray-400 text-sm">
                  <th class="pb-3 w-12">#</th>
                  <th class="pb-3">–ü–ª–µ–º—è</th>
                  <th class="pb-3 text-right">–ù–∞—Å–µ–ª–µ–Ω–∏–µ</th>
                </tr>
              </thead>
              <tbody id="topPop" class="text-sm"></tbody>
            </table>
          </div>
        </div>

        <div class="glass-card rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-2xl">üåç</span>
            <h3 class="text-xl font-bold">–ü–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è–º</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full top-table">
              <thead>
                <tr class="text-left text-gray-400 text-sm">
                  <th class="pb-3 w-12">#</th>
                  <th class="pb-3">–ü–ª–µ–º—è</th>
                  <th class="pb-3 text-right">–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</th>
                </tr>
              </thead>
              <tbody id="topTerr" class="text-sm"></tbody>
            </table>
          </div>
        </div>

        <div class="glass-card rounded-2xl p-6">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-2xl">üòä</span>
            <h3 class="text-xl font-bold">–ü–æ —Å—á–∞—Å—Ç—å—é</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full top-table">
              <thead>
                <tr class="text-left text-gray-400 text-sm">
                  <th class="pb-3 w-12">#</th>
                  <th class="pb-3">–ü–ª–µ–º—è</th>
                  <th class="pb-3 text-right">–°—á–∞—Å—Ç—å–µ</th>
                </tr>
              </thead>
              <tbody id="topHappy" class="text-sm"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Races Page -->
    <section id="page-races" class="page-section">
      <div class="mb-8">
        <h2 class="text-3xl font-bold mb-2">üåç –†–∞—Å—ã –∏ –ë–∏–æ–º—ã</h2>
        <p class="text-gray-400">–í—ã–±–µ—Ä–∏ —Å–≤–æ—é —Ä–∞—Å—É –∏ –∏–∑—É—á–∏ –ø—Ä–∞–≤–∏–ª–∞ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∫ —Ä–∞–∑–Ω—ã–º –±–∏–æ–º–∞–º</p>
      </div>

      <!-- Adaptation Rules -->
      <div class="glass-card rounded-2xl p-6 sm:p-8 mb-8">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-3">
          <span class="text-2xl">‚ö°</span>
          –ü—Ä–∞–≤–∏–ª–∞ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏
        </h3>
        <div class="grid sm:grid-cols-3 gap-4">
          <div class="p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20">
            <div class="font-semibold text-emerald-400 mb-2">–ü–æ—Ö–æ–∂–∏–π –±–∏–æ–º</div>
            <ul class="text-sm text-gray-300 space-y-1">
              <li>‚Ä¢ ‚àí10% –∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</li>
              <li>‚Ä¢ –ê–¥–∞–ø—Ç–∞—Ü–∏—è: 20 —ç–Ω–µ—Ä–≥–∏–∏</li>
              <li>‚Ä¢ –í—Ä–µ–º—è: 2 —Ç–∏–∫–∞</li>
            </ul>
          </div>
          <div class="p-4 rounded-xl bg-amber-500/10 border border-amber-500/20">
            <div class="font-semibold text-amber-400 mb-2">–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π –±–∏–æ–º</div>
            <ul class="text-sm text-gray-300 space-y-1">
              <li>‚Ä¢ ‚àí30% –∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</li>
              <li>‚Ä¢ +25% —ç–Ω–µ—Ä–≥–æ–∑–∞—Ç—Ä–∞—Ç</li>
              <li>‚Ä¢ –ê–¥–∞–ø—Ç–∞—Ü–∏—è: 60 —ç–Ω–µ—Ä–≥–∏–∏, 5 —Ç–∏–∫–æ–≤</li>
            </ul>
          </div>
          <div class="p-4 rounded-xl bg-red-500/10 border border-red-500/20">
            <div class="font-semibold text-red-400 mb-2">–≠–∫—Å—Ç—Ä–∏–º</div>
            <ul class="text-sm text-gray-300 space-y-1">
              <li>‚Ä¢ –¢–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ä–∞—Å—ã</li>
              <li>‚Ä¢ –ó–∞–ø—Ä–µ—Ç –ø–æ—Å–µ–ª–µ–Ω–∏–π</li>
              <li>‚Ä¢ –ù—É–∂–Ω—ã —Å–ø–µ—Ü–∑–¥–∞–Ω–∏—è</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Races Grid -->
      <h3 class="text-xl font-bold mb-4">üèî –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞—Å—ã</h3>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        
        <!-- Vikings -->
        <div class="race-card glass-card rounded-2xl p-5">
          <div class="flex items-start gap-4 mb-4">
            <div class="race-icon bg-blue-500/20">‚öîÔ∏è</div>
            <div>
              <h4 class="font-bold text-lg">–í–∏–∫–∏–Ω–≥–∏</h4>
              <p class="text-sm text-gray-400">—Ö–æ–ª–æ–¥ / –ø–æ–±–µ—Ä–µ–∂—å–µ</p>
            </div>
          </div>
          <div class="space-y-2 text-sm">
            <div class="buff">‚úì +15% —Ä—ã–±–æ–ª–æ–≤—Å—Ç–≤–æ</div>
            <div class="buff">‚úì +10% –±–æ–π –≤ —Ö–æ–ª–æ–¥–µ</div>
            <div class="buff">‚úì ‚àí10% –ø—Ä–∏–±—Ä–µ–∂–Ω—ã–µ –ø–æ—Å—Ç—Ä–æ–π–∫–∏</div>
          </div>
          <div class="mt-3 pt-3 border-t border-white/10">
            <div class="text-xs text-gray-500 mb-1">–í –∂–∞—Ä–µ:</div>
            <div class="space-y-1 text-sm">
              <div class="debuff">‚úó ‚àí30% —Å–µ–ª—å—Å–∫–æ–µ —Ö–æ–∑—è–π—Å—Ç–≤–æ</div>
              <div class="debuff">‚úó +20% —ç–Ω–µ—Ä–≥–æ–∑–∞—Ç—Ä–∞—Ç—ã</div>
            </div>
          </div>
        </div>

        <!-- Arabs -->
        <div class="race-card glass-card rounded-2xl p-5">
          <div class="flex items-start gap-4 mb-4">
            <div class="race-icon bg-amber-500/20">üèú</div>
            <div>
              <h4 class="font-bold text-lg">–ê—Ä–∞–±—ã</h4>
              <p class="text-sm text-gray-400">–ø—É—Å—Ç—ã–Ω—è / –æ–∞–∑–∏—Å—ã</p>
            </div>
          </div>
          <div class="space-y-2 text-sm">
            <div class="buff">‚úì +20% —É—Ä–æ–∂–∞–π –≤ –æ–∞–∑–∏—Å–∞—Ö</div>
            <div class="buff">‚úì ‚àí15% –∑–∞—Ç—Ä–∞—Ç—ã –≤–æ–¥—ã</div>
            <div class="buff">‚úì +10% —Å–∫–æ—Ä–æ—Å—Ç—å –∫–∞—Ä–∞–≤–∞–Ω–æ–≤</div>
          </div>
          <div class="mt-3 pt-3 border-t border-white/10">
            <div class="text-xs text-gray-500 mb-1">–í —Ö–æ–ª–æ–¥–µ:</div>
            <div class="space-y-1 text-sm">
              <div class="debuff">‚úó ‚àí25% —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</div>
              <div class="debuff">‚úó +25% –æ–±–æ–≥—Ä–µ–≤</div>
            </div>
          </div>
        </div>

        <!-- Eskimos -->
        <div class="race-card glass-card rounded-2xl p-5">
          <div class="flex items-start gap-4 mb-4">
            <div class="race-icon bg-cyan-500/20">‚ùÑÔ∏è</div>
            <div>
              <h4 class="font-bold text-lg">–≠—Å–∫–∏–º–æ—Å—ã</h4>
              <p class="text-sm text-gray-400">–ø–æ–ª—è—Ä–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã</p>
            </div>
          </div>
          <div class="space-y-2 text-sm">
            <div class="buff">‚úì +30% –º–æ—Ä—Å–∫–∞—è –¥–æ–±—ã—á–∞</div>
            <div class="buff">‚úì +20% —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Ö–æ–ª–æ–¥—É</div>
          </div>
          <div class="mt-3 pt-3 border-t border-white/10">
            <div class="text-xs text-gray-500 mb-1">–í –∂–∞—Ä–µ:</div>
            <div class="space-y-1 text-sm">
              <div class="debuff">‚úó ‚àí35% —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
              <div class="debuff">‚úó +30% –∑–∞—Ç—Ä–∞—Ç—ã</div>
            </div>
          </div>
        </div>

        <!-- Pygmies -->
        <div class="race-card glass-card rounded-2xl p-5">
          <div class="flex items-start gap-4 mb-4">
            <div class="race-icon bg-green-500/20">üå≥</div>
            <div>
              <h4 class="font-bold text-lg">–ü–∏–≥–º–µ–∏</h4>
              <p class="text-sm text-gray-400">–≥—É—Å—Ç—ã–µ –ª–µ—Å–∞</p>
            </div>
          </div>
          <div class="space-y-2 text-sm">
            <div class="buff">‚úì +25% —Å–±–æ—Ä —Ä–∞—Å—Ç–µ–Ω–∏–π</div>
            <div class="buff">‚úì +15% —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å</div>
          </div>
          <div class="mt-3 pt-3 border-t border-white/10">
            <div class="text-xs text-gray-500 mb-1">–í –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª—è—Ö:</div>
            <div class="space-y-1 text-sm">
              <div class="debuff">‚úó ‚àí25% –±–æ–µ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç</div>
            </div>
          </div>
        </div>

        <!-- Field people -->
        <div class="race-card glass-card rounded-2xl p-5">
          <div class="flex items-start gap-4 mb-4">
            <div class="race-icon bg-yellow-500/20">üåæ</div>
            <div>
              <h4 class="font-bold text-lg">–ü–æ–ª–µ–≤—ã–µ</h4>
              <p class="text-sm text-gray-400">–ø–æ–ª—è / –ª—É–≥–∞</p>
            </div>
          </div>
          <div class="space-y-2 text-sm">
            <div class="buff">‚úì +20% —É—Ä–æ–∂–∞–π</div>
            <div class="buff">‚úì +15% —Å–∫–æ—Ç–æ–≤–æ–¥—Å—Ç–≤–æ</div>
          </div>
          <div class="mt-3 pt-3 border-t border-white/10">
            <div class="text-xs text-gray-500 mb-1">–í –ª–µ—Å—É/–≥–æ—Ä–∞—Ö:</div>
            <div class="space-y-1 text-sm">
              <div class="debuff">‚úó ‚àí15% –∫ –¥–æ–±—ã—á–µ</div>
            </div>
          </div>
        </div>

        <!-- Sherpas -->
        <div class="race-card glass-card rounded-2xl p-5">
          <div class="flex items-start gap-4 mb-4">
            <div class="race-icon bg-slate-500/20">üèî</div>
            <div>
              <h4 class="font-bold text-lg">–®–µ—Ä–ø—ã</h4>
              <p class="text-sm text-gray-400">–≥–æ—Ä—ã / –≤—ã—Å–æ–∫–æ–≥–æ—Ä—å—è</p>
            </div>
          </div>
          <div class="space-y-2 text-sm">
            <div class="buff">‚úì +30% —Å–∫–æ—Ä–æ—Å—Ç—å –≤ –≥–æ—Ä–∞—Ö</div>
            <div class="buff">‚úì +20% –ø–µ—Ä–µ–Ω–æ—Å –≥—Ä—É–∑–æ–≤</div>
          </div>
          <div class="mt-3 pt-3 border-t border-white/10">
            <div class="text-xs text-gray-500 mb-1">–í –Ω–∏–∑–∏–Ω–∞—Ö:</div>
            <div class="space-y-1 text-sm">
              <div class="debuff">‚úó ‚àí20% —Å–∫–æ—Ä–æ—Å—Ç—å</div>
              <div class="debuff">‚úó ‚àí15% —Ñ–µ—Ä–º–µ—Ä—Å—Ç–≤–æ</div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Explain Page -->
    <section id="page-explain" class="page-section">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
        <div>
          <h2 class="text-2xl font-bold mb-1">üìñ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∏–≥—Ä—ã</h2>
          <p class="text-gray-400">–ù–∞–∂–º–∏ –Ω–∞ —Ä–∞–∑–¥–µ–ª, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</p>
        </div>
        <div id="explainControls" class="hidden">
          <button onclick="openAddRuleModal()" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª</button>
        </div>
      </div>

      <div id="rulesAccordion" class="space-y-3"></div>
    </section>

    <!-- Admin Panel -->
    <section id="adminPanel" class="hidden mt-8">
      <div class="glass-card rounded-2xl p-6 sm:p-8 border-emerald-500/30">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center">‚öôÔ∏è</div>
          <div>
            <h2 class="text-xl font-bold">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
            <p class="text-sm text-gray-400">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ –∏–≥—Ä—ã</p>
          </div>
        </div>

        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
          <button onclick="giveEnergyAll()" class="p-4 rounded-xl bg-white/5 hover:bg-white/10 transition text-left">
            <div class="text-2xl mb-2">‚ö°Ô∏è</div>
            <div class="font-medium">+15 —ç–Ω–µ—Ä–≥–∏–∏ –≤—Å–µ–º</div>
            <div class="text-sm text-gray-400">–°–∏–º—É–ª—è—Ü–∏—è —Ç–∏–∫–∞</div>
          </button>
          <button onclick="randomEvent()" class="p-4 rounded-xl bg-white/5 hover:bg-white/10 transition text-left">
            <div class="text-2xl mb-2">üé≤</div>
            <div class="font-medium">–°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ</div>
            <div class="text-sm text-gray-400">–ü–æ–∂–∞—Ä, —ç–ø–∏–¥–µ–º–∏—è –∏ —Ç.–¥.</div>
          </button>
          <button onclick="saveToCloud()" class="p-4 rounded-xl bg-emerald-500/20 hover:bg-emerald-500/30 transition text-left border border-emerald-500/30">
            <div class="text-2xl mb-2">‚òÅÔ∏è</div>
            <div class="font-medium">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</div>
            <div class="text-sm text-gray-400">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Firebase</div>
          </button>
        </div>

        <div class="grid sm:grid-cols-2 gap-4 mb-6">
          <div class="p-4 rounded-xl bg-white/5">
            <h3 class="font-medium mb-3">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º</h3>
            <div class="space-y-2">
              <button onclick="setAsOwner()" class="w-full text-left px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-sm">üëë –ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–µ–±—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º</button>
              <div class="flex gap-2">
                <input id="newAdminInput" type="text" placeholder="UID –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞" class="flex-1 px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm focus:outline-none focus:border-emerald-500">
                <button onclick="addAdmin()" class="px-3 py-2 rounded-lg bg-emerald-500/20 hover:bg-emerald-500/30 text-sm">+</button>
              </div>
            </div>
          </div>
          <div class="p-4 rounded-xl bg-white/5">
            <h3 class="font-medium mb-3">–≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç</h3>
            <div class="flex flex-wrap gap-2">
              <button onclick="exportData()" class="px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-sm">üì• –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
              <label class="px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-sm cursor-pointer">
                üì§ –ò–º–ø–æ—Ä—Ç JSON
                <input type="file" id="importFile" accept="application/json" class="hidden">
              </label>
              <button onclick="loadFromCloud()" class="px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-sm">‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</button>
            </div>
          </div>
        </div>

        <!-- Owner Only: Password Management -->
        <div id="ownerPasswordSection" class="hidden p-4 rounded-xl bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/30 mb-6">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-2xl">üëë</span>
            <div>
              <h3 class="font-bold text-amber-400">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è–º–∏</h3>
              <p class="text-sm text-gray-400">–¢–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞</p>
            </div>
          </div>
          
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2 text-gray-300">–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
              <div class="flex gap-2">
                <input type="text" id="newAdminPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" class="flex-1 px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm focus:outline-none focus:border-amber-500">
                <button onclick="changeAdminPassword()" class="px-4 py-2 rounded-lg bg-amber-500/20 hover:bg-amber-500/30 text-sm font-medium border border-amber-500/30">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </div>
              <p class="text-xs text-gray-500 mt-1">–¢–µ–∫—É—â–∏–π: <span id="currentAdminPass">***</span></p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2 text-gray-300">–ü–∞—Ä–æ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞</label>
              <div class="flex gap-2">
                <input type="text" id="newOwnerPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" class="flex-1 px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm focus:outline-none focus:border-amber-500">
                <button onclick="changeOwnerPassword()" class="px-4 py-2 rounded-lg bg-amber-500/20 hover:bg-amber-500/30 text-sm font-medium border border-amber-500/30">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </div>
              <p class="text-xs text-gray-500 mt-1">–¢–µ–∫—É—â–∏–π: <span id="currentOwnerPass">***</span></p>
            </div>
          </div>
          
          <div class="mt-4 flex items-center gap-2">
            <input type="checkbox" id="showPasswords" onchange="toggleShowPasswords()" class="w-4 h-4 rounded bg-white/5 border-white/20">
            <label for="showPasswords" class="text-sm text-gray-400 cursor-pointer">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–æ–ª–∏</label>
          </div>
        </div>

        <div class="text-sm text-gray-500">
          –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: <span id="lastSaved">‚Äî</span>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 flex items-center justify-center p-4">
      <div class="modal-content glass-card rounded-2xl p-6 w-full max-w-md relative">
        <h3 class="text-xl font-bold mb-4">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
        
        <div class="space-y-4">
          <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-xl bg-white text-gray-900 font-medium hover:bg-gray-100 transition">
            <svg class="w-5 h-5" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
          </button>

          <div class="relative">
            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div>
            <div class="relative flex justify-center text-sm"><span class="px-2 bg-slate-900 text-gray-400">–∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ</span></div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">–†–æ–ª—å</label>
            <select id="localRole" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-emerald-500">
              <option value="admin">–ê–¥–º–∏–Ω</option>
              <option value="owner">–í–ª–∞–¥–µ–ª–µ—Ü</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="localPassword" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-emerald-500" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
          </div>

          <button onclick="localLogin()" class="w-full btn-primary px-4 py-3 rounded-xl font-medium">–í–æ–π—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ</button>
        </div>

        <button onclick="closeLoginModal()" class="absolute top-4 right-4 p-2 hover:bg-white/10 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Tribe Modal -->
  <div id="editTribeModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 flex items-center justify-center p-4">
      <div class="modal-content glass-card rounded-2xl p-6 w-full max-w-md relative">
        <h3 class="text-xl font-bold mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–µ–º–µ–Ω–∏</h3>
        <input type="hidden" id="editTribeId">
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" id="editTribeName" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-emerald-500">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">–ê—Ä–º–∏—è</label>
              <input type="number" id="editTribeArmy" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-emerald-500">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">–ù–∞—Å–µ–ª–µ–Ω–∏–µ</label>
              <input type="number" id="editTribePop" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-emerald-500">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</label>
              <input type="number" id="editTribeTerr" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-emerald-500">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">–°—á–∞—Å—Ç—å–µ %</label>
              <input type="number" id="editTribeHappy" min="0" max="100" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-emerald-500">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">–≠–Ω–µ—Ä–≥–∏—è</label>
            <input type="number" id="editTribeEnergy" min="0" max="100" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-emerald-500">
          </div>
        </div>

        <div class="flex gap-3 mt-6">
          <button onclick="closeEditTribeModal()" class="flex-1 px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 font-medium">–û—Ç–º–µ–Ω–∞</button>
          <button onclick="deleteTribe()" class="px-4 py-2 rounded-xl btn-danger font-medium">üóë</button>
          <button onclick="saveTribe()" class="flex-1 btn-primary px-4 py-2 rounded-xl font-medium">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>

        <button onclick="closeEditTribeModal()" class="absolute top-4 right-4 p-2 hover:bg-white/10 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Rule Modal -->
  <div id="editRuleModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 flex items-center justify-center p-4">
      <div class="modal-content glass-card rounded-2xl p-6 w-full max-w-lg relative max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4" id="editRuleTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞</h3>
        <input type="hidden" id="editRuleId">
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">–ò–∫–æ–Ω–∫–∞ (—ç–º–æ–¥–∑–∏)</label>
            <input type="text" id="editRuleIcon" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-emerald-500" placeholder="üîã">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input type="text" id="editRuleTitleInput" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-emerald-500" placeholder="–≠–ù–ï–†–ì–ò–Ø –ü–õ–ï–ú–ï–ù–ò">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
            <textarea id="editRuleContent" rows="10" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 focus:outline-none focus:border-emerald-500 resize-y" placeholder="–¢–µ–∫—Å—Ç —Ä–∞–∑–¥–µ–ª–∞..."></textarea>
          </div>
        </div>

        <div class="flex gap-3 mt-6">
          <button onclick="closeEditRuleModal()" class="flex-1 px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 font-medium">–û—Ç–º–µ–Ω–∞</button>
          <button onclick="deleteRule()" id="deleteRuleBtn" class="px-4 py-2 rounded-xl btn-danger font-medium">üóë –£–¥–∞–ª–∏—Ç—å</button>
          <button onclick="saveRule()" class="flex-1 btn-primary px-4 py-2 rounded-xl font-medium">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>

        <button onclick="closeEditRuleModal()" class="absolute top-4 right-4 p-2 hover:bg-white/10 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCscnMBP6XVMdFRo7TPbn6qmQRtJ045f9I",
      authDomain: "new-earth-cd366.firebaseapp.com",
      projectId: "new-earth-cd366",
      storageBucket: "new-earth-cd366.appspot.com",
      messagingSenderId: "346630323608",
      appId: "1:346630323608:web:135d4fd9118404f62e3fed",
      measurementId: "G-N6BN0H0R9L"
    };

    let firebaseApp, auth, db, storage;
    try {
      firebaseApp = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      storage = firebase.storage();
    } catch (e) {
      console.error('Firebase init error:', e);
    }

    const STORAGE_KEY = 'nova_zemlya_v8';
    let state = null;
    let currentUser = null;
    let role = 'guest';

    const defaultState = {
      meta: {
        ownerName: '–í–ª–∞–¥–µ–ª–µ—Ü',
        ownerPass: 'owner123',
        adminPass: 'admin123',
        ownerUid: null,
        admins: [],
        publicEdit: false,
        gameActive: true
      },
      map: { dataUrl: '', name: '', updatedAt: null },
      players: [
        { id: 1, name: '–ú–ï–¢–ê–ú–§–ò–õ–ï–ù–î', army: 0, pop: 7, territories: 24, happy: 50, energy: 50 },
        { id: 2, name: '–°–Ω—é—Å–õ–µ–Ω–¥', army: 0, pop: 7, territories: 0, happy: 50, energy: 50 },
        { id: 3, name: '–°.–ö.–î.–ü.–ú–§–ê.–ê', army: 0, pop: 5, territories: 0, happy: 50, energy: 50 },
        { id: 4, name: '–ë.–î.–ú.–ì', army: 0, pop: 5, territories: 0, happy: 50, energy: 50 },
        { id: 5, name: '–ù–∏–º—Ü–µ—Ñ–∏–ª–∏—è', army: 0, pop: 5, territories: 0, happy: 50, energy: 50 },
        { id: 6, name: '–í–∏–Ω–ª–∞–Ω–¥', army: 0, pop: 5, territories: 0, happy: 50, energy: 50 },
        { id: 7, name: '–ë—É—Ä', army: 0, pop: 5, territories: 0, happy: 50, energy: 50 },
        { id: 8, name: '–°.–ë.–£', army: 0, pop: 5, territories: 0, happy: 50, energy: 50 },
        { id: 9, name: '–ü–µ—Ä–¥–µ—à–≥—Ä–∞–¥', army: 0, pop: 5, territories: 0, happy: 50, energy: 50 },
        { id: 10, name: '–í–∞—Ä—Ç–æ–ª–∏—Å', army: 0, pop: 5, territories: 0, happy: 50, energy: 50 },
        { id: 11, name: '–¢—É–ª—å–±–∏–Ω—Å–∫', army: 0, pop: 5, territories: 0, happy: 50, energy: 50 }
      ],
      rules: getDefaultRules(),
      updatedAt: Date.now()
    };

    function getDefaultRules() {
      return [
        { id: 'energy', icon: 'üîã', title: '–≠–ù–ï–†–ì–ò–Ø –ü–õ–ï–ú–ï–ù–ò', content: `‚è±Ô∏è –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç –ø–ª–µ–º—è –ø–æ–ª—É—á–∞–µ—Ç 15 —ç–Ω–µ—Ä–≥–∏–∏\nüîí –ú–∞–∫—Å–∏–º—É–º —ç–Ω–µ—Ä–≥–∏–∏: 100\nüìà –ú–∞–∫—Å–∏–º—É–º —ç–Ω–µ—Ä–≥–∏–∏ –º–æ–∂–µ—Ç –ø–æ–≤—ã—à–∞—Ç—å—Å—è —Å —Ä–∞–∑–≤–∏—Ç–∏–µ–º –ø–ª–µ–º–µ–Ω–∏` },
        { id: 'spending', icon: 'üõñ', title: '–†–ê–°–•–û–î –≠–ù–ï–†–ì–ò–ò', content: `ü™µ –°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–û –ò –ë–´–¢\n‚Ä¢ –£–ª—É—á—à–µ–Ω–∏–µ –ø–æ—Å–µ–ª–µ–Ω–∏—è ‚Äî 10 —ç–Ω–µ—Ä–≥–∏–∏\n\nüó∫ –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ò –†–ê–°–®–ò–†–ï–ù–ò–ï\n‚Ä¢ –†–∞–∑–≤–µ–¥–∫–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) ‚Äî –æ—Ç 10 –¥–æ 80 —ç–Ω–µ—Ä–≥–∏–∏\n‚Ä¢ –ó–∞—Ö–≤–∞—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ ‚Äî –æ—Ç 20 –¥–æ 80 —ç–Ω–µ—Ä–≥–∏–∏\n‚Ä¢ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–∑–≤–µ–¥—á–∏–∫–æ–≤ ‚Äî 25 —ç–Ω–µ—Ä–≥–∏–∏\n‚Ä¢ –î–∞–ª—å–Ω–∏–π –ø–æ—Ö–æ–¥ –∫ –Ω–æ–≤—ã–º –∑–µ–º–ª—è–º ‚Äî 45 —ç–Ω–µ—Ä–≥–∏–∏\n\nüó° –í–û–ô–°–ö–û –ò –ó–ê–©–ò–¢–ê –ü–õ–ï–ú–ï–ù–ò\nüë• –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–æ–∏–Ω–æ–≤ (–∫–æ–ø—å—è, –¥—É–±–∏–Ω—ã, –∫–æ—Å—Ç–∏):\n‚Ä¢ 5 –≤–æ–∏–Ω–æ–≤ ‚Äî 10 —ç–Ω–µ—Ä–≥–∏–∏\n‚ö†Ô∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: –Ω–∞—Å–µ–ª–µ–Ω–∏–µ –Ω–µ –º–µ–Ω–µ–µ 10\n\nüõ° –û–±–æ—Ä–æ–Ω–∞:\n‚Ä¢ –°—Ç–µ–Ω–∞ –∏–∑ –±—Ä—ë–≤–µ–Ω / —á–∞—Å—Ç–æ–∫–æ–ª ‚Äî 35 —ç–Ω–µ—Ä–≥–∏–∏` },
        { id: 'research', icon: 'üß†', title: '–ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø', content: `ü™ì –£–õ–£–ß–®–ï–ù–ò–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í\n‚Ä¢ I —É—Ä ‚Äî 25 —ç–Ω–µ—Ä–≥–∏–∏\n‚Ä¢ II —É—Ä ‚Äî 50 —ç–Ω–µ—Ä–≥–∏–∏\n‚Ä¢ III —É—Ä ‚Äî 90 —ç–Ω–µ—Ä–≥–∏–∏\n\nüõ† –°–¢–†–û–ò–¢–ï–õ–¨–ù–û–ï –†–ï–ú–ï–°–õ–û\n‚Ä¢ I —É—Ä ‚Äî 20 —ç–Ω–µ—Ä–≥–∏–∏\n‚Ä¢ II —É—Ä ‚Äî 40 —ç–Ω–µ—Ä–≥–∏–∏\n‚Ä¢ III —É—Ä ‚Äî 70 —ç–Ω–µ—Ä–≥–∏–∏\n\nüåø –õ–ï–ö–ê–†–°–¢–í–û –ò –®–ê–ú–ê–ù–°–¢–í–û\n‚Ä¢ I —É—Ä ‚Äî 35 —ç–Ω–µ—Ä–≥–∏–∏\n‚Ä¢ II —É—Ä ‚Äî 70 —ç–Ω–µ—Ä–≥–∏–∏\n‚Ä¢ III —É—Ä ‚Äî 100 —ç–Ω–µ—Ä–≥–∏–∏` },
        { id: 'storage', icon: 'üóø', title: '–•–†–ê–ù–ò–õ–ò–©–ï –≠–ù–ï–†–ì–ò–ò', content: `‚Ä¢ I —É—Ä–æ–≤–µ–Ω—å ‚Äî 0 —ç–Ω–µ—Ä–≥–∏–∏ | –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: 100 —ç–Ω–µ—Ä–≥–∏–∏\n‚Ä¢ II —É—Ä–æ–≤–µ–Ω—å ‚Äî 100 —ç–Ω–µ—Ä–≥–∏–∏ | –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: 110 —ç–Ω–µ—Ä–≥–∏–∏\n‚Ä¢ III —É—Ä–æ–≤–µ–Ω—å ‚Äî 110 —ç–Ω–µ—Ä–≥–∏–∏ | –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: 120 —ç–Ω–µ—Ä–≥–∏–∏` },
        { id: 'taxes', icon: 'üí∞', title: '–ù–ê–õ–û–ì–ò –í –ü–õ–ï–ú–ï–ù–ò', content: `–í–æ–∂–¥—å –º–æ–∂–µ—Ç –≤–≤–æ–¥–∏—Ç—å –Ω–∞–ª–æ–≥–∏ ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é –æ—Ç–¥–∞—á—É —ç–Ω–µ—Ä–≥–∏–∏, —Ä–µ—Å—É—Ä—Å–æ–≤ –∏–ª–∏ —Ç—Ä—É–¥–∞.\n\nüìä –£–†–û–í–ù–ò –ù–ê–õ–û–ì–û–í (–≤ –¥–µ–Ω—å):\n\n‚Ä¢ –ù–∏–∑–∫–∏–µ –Ω–∞–ª–æ–≥–∏: +5 —ç–Ω–µ—Ä–≥–∏–∏, +10% —Å—á–∞—Å—Ç—å—è\n‚Ä¢ –°—Ä–µ–¥–Ω–∏–µ –Ω–∞–ª–æ–≥–∏: +15 —ç–Ω–µ—Ä–≥–∏–∏, ‚àí40% —Å—á–∞—Å—Ç—å—è\n‚Ä¢ –í—ã—Å–æ–∫–∏–µ –Ω–∞–ª–æ–≥–∏: +30 —ç–Ω–µ—Ä–≥–∏–∏, ‚àí70% —Å—á–∞—Å—Ç—å—è\n\n‚ö†Ô∏è –ß–µ–º –≤—ã—à–µ –Ω–∞–ª–æ–≥–∏ ‚Äî —Ç–µ–º –≤—ã—à–µ —Ä–∏—Å–∫ –≤–æ—Å—Å—Ç–∞–Ω–∏—è!` },
        { id: 'happiness', icon: 'üòä', title: '–°–ß–ê–°–¢–¨–ï –ü–õ–ï–ú–ï–ù–ò', content: `–°—á–∞—Å—Ç—å–µ –∏–∑–º–µ—Ä—è–µ—Ç—Å—è –æ—Ç 0% –¥–æ 100%.\n‚Ä¢ –°—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å—á–∞—Å—Ç—å–µ: 50%\n‚Ä¢ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –≤–æ–π–Ω—ã: ‚àí15% (—Ä–∞–∑–æ–≤–æ)\n\nüìâ –ü–ê–î–ï–ù–ò–ï –°–ß–ê–°–¢–¨–Ø (—à—Ç—Ä–∞—Ñ—ã –≤ –¥–µ–Ω—å):\n‚Ä¢ –ö–∞–∂–¥–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –≤–æ–π–Ω–∞ ‚Äî ‚àí5%\n‚Ä¢ –î–æ–ª–≥–∞—è –≤–æ–π–Ω–∞ (–±–æ–ª–µ–µ 3 –¥–Ω–µ–π) ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ ‚àí5%\n‚Ä¢ –ù–µ—Ö–≤–∞—Ç–∫–∞ –µ–¥—ã ‚Äî ‚àí10%\n‚Ä¢ –ü–ª–æ—Ö–∏–µ —É—Å–ª–æ–≤–∏—è –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è ‚Äî ‚àí5%\n‚Ä¢ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ç—Ä—É–¥ / –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ø–æ—Ö–æ–¥—ã ‚Äî ‚àí5%\n\nüìà –ü–û–í–´–®–ï–ù–ò–ï –°–ß–ê–°–¢–¨–Ø (–±–æ–Ω—É—Å—ã –≤ –¥–µ–Ω—å):\n‚Ä¢ –ù–∏–∑–∫–∏–µ –Ω–∞–ª–æ–≥–∏ ‚Äî +10%\n‚Ä¢ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–æ–π–Ω ‚Äî +15%\n‚Ä¢ –•–æ—Ä–æ—à–∏–µ —É—Å–ª–æ–≤–∏—è –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è ‚Äî +15%\n‚Ä¢ –°–≤—è—Ç–∏–ª–∏—â–∞, —Ç–æ—Ç–µ–º—ã, –æ–±—Ä—è–¥—ã ‚Äî +10%` },
        { id: 'events', icon: 'üå™', title: '–ù–ï–û–ñ–ò–î–ê–ù–ù–´–ï –û–ë–°–¢–û–Ø–¢–ï–õ–¨–°–¢–í–ê', content: `–í –ø–ª–µ–º–µ–Ω–∏ –º–æ–≥—É—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ –∏–ª–∏ —Å—é–∂–µ—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:\n\n‚Ä¢ –ü–æ–∂–∞—Ä—ã\n‚Ä¢ –ó–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏—è\n‚Ä¢ –≠–ø–∏–¥–µ–º–∏–∏\n‚Ä¢ –°–º–µ—Ä—Ç—å –≥—Ä–∞–∂–¥–∞–Ω / —Å—Ç–∞—Ä–µ–π—à–∏–Ω\n‚Ä¢ –ì–∏–±–µ–ª—å –æ—Ö–æ—Ç–Ω–∏–∫–æ–≤ –∏–ª–∏ –≤–æ–∏–Ω–æ–≤\n‚Ä¢ –°—Ç–∏—Ö–∏–π–Ω—ã–µ –±–µ–¥—Å—Ç–≤–∏—è\n\nüìâ –≠—Ñ—Ñ–µ–∫—Ç: ‚àí5% –¥–æ ‚àí20% —Å—á–∞—Å—Ç—å—è (–≤—Ä–µ–º–µ–Ω–Ω–æ)\nüìå –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏–π –º–æ–≥—É—Ç —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å—Å—è` },
        { id: 'revolt', icon: '‚ö†Ô∏è', title: '–í–û–°–°–¢–ê–ù–ò–ï', content: `‚Ä¢ 30% —Å—á–∞—Å—Ç—å—è –∏ –Ω–∏–∂–µ ‚Äî –≤–æ–∑–º–æ–∂–µ–Ω –±—É–Ω—Ç\n‚Ä¢ 10% —Å—á–∞—Å—Ç—å—è –∏ –Ω–∏–∂–µ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–∏–µ\n\nüî• –ü–û–°–õ–ï–î–°–¢–í–ò–Ø –í–û–°–°–¢–ê–ù–ò–Ø:\n‚Ä¢ –ü–æ—Ç–µ—Ä—è —á–∞—Å—Ç–∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π\n‚Ä¢ –ü–æ—Ç–µ—Ä–∏ –≤–æ–∏–Ω–æ–≤\n‚Ä¢ –†–∞–∑—Ä—É—à–µ–Ω–∏–µ –ø–æ—Å—Ç—Ä–æ–µ–∫\n‚Ä¢ –í–æ–∑–º–æ–∂–Ω–∞—è —Å–º–µ–Ω–∞ –≤–æ–∂–¥—è (–ø–æ —É—Å–º–æ—Ç—Ä–µ–Ω–∏—é –º–∞—Å—Ç–µ—Ä–∞)` }
      ];
    }

    function loadState() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          state = JSON.parse(saved);
          if (!state.rules || state.rules.length === 0) state.rules = getDefaultRules();
          if (state.meta.gameActive === undefined) state.meta.gameActive = true;
          return;
        } catch (e) {}
      }
      state = JSON.parse(JSON.stringify(defaultState));
      saveState();
    }

    function saveState() {
      state.updatedAt = Date.now();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      updateLastSaved();
    }

    function toast(message, isError = false) {
      const t = document.getElementById('toast');
      t.textContent = message;
      t.className = 'toast show' + (isError ? ' error' : '');
      setTimeout(() => t.className = 'toast', 3000);
    }

    function showPage(page) {
      document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
      
      const section = document.getElementById('page-' + page);
      if (section) {
        section.classList.add('active');
        document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
      }
    }

    function toggleMobileMenu() {
      document.getElementById('mobileMenu').classList.toggle('hidden');
    }

    function renderAll() {
      renderStats();
      renderTribes();
      renderTops();
      renderRules();
      renderMap();
      renderLeadersPreview();
      renderGameStatus();
      updateUI();
    }

    function renderGameStatus() {
      const isActive = state.meta?.gameActive !== false;
      const badge = document.getElementById('gameStatusBadge');
      const dot = document.getElementById('gameStatusDot');
      const text = document.getElementById('gameStatusText');
      const toggle = document.getElementById('statusToggleBtn');
      
      if (isActive) {
        badge.className = 'inline-flex items-center gap-2 px-4 py-2 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-sm font-medium';
        dot.className = 'w-2 h-2 rounded-full bg-emerald-500 animate-pulse';
        text.textContent = '–ò–≥—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞';
        toggle?.classList.add('active');
      } else {
        badge.className = 'inline-flex items-center gap-2 px-4 py-2 rounded-full bg-red-500/10 border border-red-500/20 text-red-400 text-sm font-medium';
        dot.className = 'w-2 h-2 rounded-full bg-red-500';
        text.textContent = '–ò–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ';
        toggle?.classList.remove('active');
      }
    }

    function toggleGameStatus() {
      if (!canEditState()) return toast('–ù–µ—Ç –ø—Ä–∞–≤', true);
      state.meta.gameActive = !state.meta.gameActive;
      saveState();
      renderGameStatus();
      toast(state.meta.gameActive ? '–ò–≥—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!' : '–ò–≥—Ä–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
    }

    function renderStats() {
      const players = state.players || [];
      document.getElementById('stat-tribes').textContent = players.length;
      document.getElementById('stat-population').textContent = players.reduce((s, p) => s + (p.pop || 0), 0);
      document.getElementById('stat-territories').textContent = players.reduce((s, p) => s + (p.territories || 0), 0);
      document.getElementById('stat-army').textContent = players.reduce((s, p) => s + (p.army || 0), 0);
    }

    function renderLeadersPreview() {
      const container = document.getElementById('leadersPreview');
      const sorted = [...state.players].sort((a, b) => b.territories - a.territories).slice(0, 3);
      
      container.innerHTML = sorted.map((p, i) => `
        <div class="p-4 rounded-xl ${i === 0 ? 'bg-gradient-to-br from-amber-500/20 to-amber-600/10 border border-amber-500/30' : 'bg-white/5'}">
          <div class="flex items-center gap-3 mb-2">
            <div class="rank-badge ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : 'rank-3'}">${i + 1}</div>
            <div class="font-semibold">${escapeHtml(p.name)}</div>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm text-gray-400">
            <div>üåç ${p.territories} —Ç–µ—Ä—Ä.</div>
            <div>üë• ${p.pop} –ø–æ–ø.</div>
          </div>
        </div>
      `).join('');
    }

    function renderTribes() {
      const container = document.getElementById('tribesGrid');
      const canEdit = canEditState();
      
      container.innerHTML = state.players.map(p => {
        const energyPercent = (p.energy || 0);
        
        return `
          <div class="tribe-card glass-card rounded-2xl p-5">
            <div class="flex items-start justify-between mb-4">
              <div>
                <h3 class="font-bold text-lg">${escapeHtml(p.name)}</h3>
                <div class="text-sm text-gray-400 mt-1">ID: ${p.id}</div>
              </div>
              ${canEdit ? `
                <button onclick="openEditTribe(${p.id})" class="p-2 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              ` : ''}
            </div>

            <div class="space-y-3">
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-400">‚ö° –≠–Ω–µ—Ä–≥–∏—è</span>
                <span class="font-medium">${energyPercent}/100</span>
              </div>
              <div class="stat-bar">
                <div class="stat-fill bg-gradient-to-r from-amber-500 to-amber-400" style="width: ${energyPercent}%"></div>
              </div>

              <div class="grid grid-cols-2 gap-3 pt-2">
                <div class="text-center p-2 rounded-lg bg-white/5">
                  <div class="text-xl font-bold text-indigo-400">${p.army}</div>
                  <div class="text-xs text-gray-400">‚öîÔ∏è –ê—Ä–º–∏—è</div>
                </div>
                <div class="text-center p-2 rounded-lg bg-white/5">
                  <div class="text-xl font-bold text-emerald-400">${p.pop}</div>
                  <div class="text-xs text-gray-400">üë• –ù–∞—Å–µ–ª–µ–Ω–∏–µ</div>
                </div>
                <div class="text-center p-2 rounded-lg bg-white/5">
                  <div class="text-xl font-bold text-blue-400">${p.territories}</div>
                  <div class="text-xs text-gray-400">üåç –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</div>
                </div>
                <div class="text-center p-2 rounded-lg bg-white/5">
                  <div class="text-xl font-bold ${p.happy >= 50 ? 'text-emerald-400' : 'text-red-400'}">${p.happy}%</div>
                  <div class="text-xs text-gray-400">üòä –°—á–∞—Å—Ç—å–µ</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderTops() {
      renderTopTable('topArmy', 'army', '‚öîÔ∏è');
      renderTopTable('topPop', 'pop', 'üë•');
      renderTopTable('topTerr', 'territories', 'üåç');
      renderTopTable('topHappy', 'happy', 'üòä', '%');
    }

    function renderTopTable(elementId, key, icon, suffix = '') {
      const tbody = document.getElementById(elementId);
      const sorted = [...state.players].sort((a, b) => b[key] - a[key]).slice(0, 12);
      
      tbody.innerHTML = sorted.map((p, i) => `
        <tr class="border-b border-white/5">
          <td class="py-3">
            <div class="rank-badge ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'bg-white/10'}">${i + 1}</div>
          </td>
          <td class="py-3 font-medium">${escapeHtml(p.name)}</td>
          <td class="py-3 text-right font-mono">${p[key]}${suffix}</td>
        </tr>
      `).join('');
    }

    function renderRules() {
      const container = document.getElementById('rulesAccordion');
      const rules = state.rules || getDefaultRules();
      const canEdit = canEditState();
      
      container.innerHTML = rules.map(rule => `
        <div class="accordion-item glass-card rounded-xl overflow-hidden" data-rule-id="${rule.id}">
          <div class="accordion-header p-4 flex items-center justify-between" onclick="toggleRule('${rule.id}')">
            <div class="flex items-center gap-3">
              <span class="text-2xl">${rule.icon}</span>
              <span class="font-semibold">${escapeHtml(rule.title)}</span>
            </div>
            <div class="flex items-center gap-1">
              ${canEdit ? `
                <button onclick="event.stopPropagation(); quickDeleteRule('${rule.id}')" class="delete-rule-btn p-2 rounded-lg hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition" title="–£–¥–∞–ª–∏—Ç—å">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
                <button onclick="event.stopPropagation(); openEditRule('${rule.id}')" class="p-2 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              ` : ''}
              <svg class="accordion-icon w-5 h-5 text-gray-400 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </div>
          </div>
          <div class="accordion-content">
            <div class="px-4 pb-4 pt-2 text-sm text-gray-300 whitespace-pre-line leading-relaxed">${escapeHtml(rule.content)}</div>
          </div>
        </div>
      `).join('');
    }

    function quickDeleteRule(id) {
      if (!canEditState()) return toast('–ù–µ—Ç –ø—Ä–∞–≤', true);
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª?')) return;
      
      state.rules = state.rules.filter(r => r.id !== id);
      saveState();
      renderRules();
      toast('–†–∞–∑–¥–µ–ª —É–¥–∞–ª—ë–Ω');
    }

    function toggleRule(id) {
      const item = document.querySelector(`[data-rule-id="${id}"]`);
      const content = item.querySelector('.accordion-content');
      const isOpen = item.classList.contains('open');
      
      document.querySelectorAll('.accordion-item').forEach(el => {
        el.classList.remove('open');
        el.querySelector('.accordion-content').classList.remove('open');
      });
      
      if (!isOpen) {
        item.classList.add('open');
        content.classList.add('open');
      }
    }

    function renderMap() {
      const img = document.getElementById('mapImage');
      const placeholder = document.getElementById('mapPlaceholder');
      const lastUpdate = document.getElementById('mapLastUpdate');
      
      if (state.map && state.map.dataUrl) {
        img.src = state.map.dataUrl;
        img.classList.remove('hidden');
        placeholder.classList.add('hidden');
        lastUpdate.textContent = state.map.updatedAt ? new Date(state.map.updatedAt).toLocaleString('ru') : '‚Äî';
      } else {
        img.classList.add('hidden');
        placeholder.classList.remove('hidden');
        lastUpdate.textContent = '‚Äî';
      }
    }

    function canEditState() {
      if (currentUser && state.meta) {
        if (state.meta.ownerUid === currentUser.uid) return true;
        if (state.meta.admins?.includes(currentUser.uid)) return true;
      }
      return role === 'owner' || role === 'admin';
    }

    function isOwner() {
      if (currentUser && state.meta && state.meta.ownerUid === currentUser.uid) return true;
      return role === 'owner';
    }

    function updateUI() {
      const canEdit = canEditState();
      const ownerMode = isOwner();
      
      document.getElementById('adminPanel').classList.toggle('hidden', !canEdit);
      document.getElementById('mapControls').classList.toggle('hidden', !canEdit);
      document.getElementById('tribeControls').classList.toggle('hidden', !canEdit);
      document.getElementById('explainControls').classList.toggle('hidden', !canEdit);
      document.getElementById('gameStatusToggle').classList.toggle('hidden', !canEdit);
      document.getElementById('ownerPasswordSection').classList.toggle('hidden', !ownerMode);
      
      // Update password display
      if (ownerMode) {
        updatePasswordDisplay();
      }
      
      const badge = document.getElementById('roleBadge');
      let roleText = '–ì–æ—Å—Ç—å';
      let roleColor = 'bg-gray-500';
      
      if (currentUser) {
        if (state.meta?.ownerUid === currentUser.uid) {
          roleText = '–í–ª–∞–¥–µ–ª–µ—Ü';
          roleColor = 'bg-amber-500';
        } else if (state.meta?.admins?.includes(currentUser.uid)) {
          roleText = '–ê–¥–º–∏–Ω';
          roleColor = 'bg-emerald-500';
        } else {
          roleText = currentUser.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
          roleColor = 'bg-blue-500';
        }
      } else if (role === 'owner') {
        roleText = '–í–ª–∞–¥–µ–ª–µ—Ü';
        roleColor = 'bg-amber-500';
      } else if (role === 'admin') {
        roleText = '–ê–¥–º–∏–Ω';
        roleColor = 'bg-emerald-500';
      }
      
      badge.innerHTML = `<span class="w-2 h-2 rounded-full ${roleColor}"></span><span>${roleText}</span>`;
      
      document.getElementById('loginBtn').classList.toggle('hidden', !!currentUser || role !== 'guest');
      document.getElementById('logoutBtn').classList.toggle('hidden', !currentUser && role === 'guest');
      
      updateLastSaved();
    }

    function updatePasswordDisplay() {
      const showPasswords = document.getElementById('showPasswords')?.checked;
      document.getElementById('currentAdminPass').textContent = showPasswords ? state.meta.adminPass : '***';
      document.getElementById('currentOwnerPass').textContent = showPasswords ? state.meta.ownerPass : '***';
    }

    function toggleShowPasswords() {
      updatePasswordDisplay();
    }

    function changeAdminPassword() {
      if (!isOwner()) return toast('–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –ø–∞—Ä–æ–ª–∏', true);
      
      const newPass = document.getElementById('newAdminPassword').value.trim();
      if (!newPass) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å', true);
      if (newPass.length < 4) return toast('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞', true);
      
      state.meta.adminPass = newPass;
      saveState();
      document.getElementById('newAdminPassword').value = '';
      updatePasswordDisplay();
      toast('–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω—ë–Ω!');
    }

    function changeOwnerPassword() {
      if (!isOwner()) return toast('–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –ø–∞—Ä–æ–ª–∏', true);
      
      const newPass = document.getElementById('newOwnerPassword').value.trim();
      if (!newPass) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å', true);
      if (newPass.length < 4) return toast('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞', true);
      
      state.meta.ownerPass = newPass;
      saveState();
      document.getElementById('newOwnerPassword').value = '';
      updatePasswordDisplay();
      toast('–ü–∞—Ä–æ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏–∑–º–µ–Ω—ë–Ω!');
    }

    function updateLastSaved() {
      const el = document.getElementById('lastSaved');
      if (el && state.updatedAt) {
        el.textContent = new Date(state.updatedAt).toLocaleString('ru');
      }
    }

    // Modals
    function openLoginModal() {
      const modal = document.getElementById('loginModal');
      modal.classList.remove('hidden');
      setTimeout(() => modal.querySelector('.modal-backdrop').classList.add('show'), 10);
    }

    function closeLoginModal() {
      const modal = document.getElementById('loginModal');
      modal.querySelector('.modal-backdrop').classList.remove('show');
      setTimeout(() => modal.classList.add('hidden'), 300);
    }

    async function signInWithGoogle() {
      if (!auth) return toast('Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', true);
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        closeLoginModal();
        toast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
      } catch (e) {
        toast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + e.message, true);
      }
    }

    function localLogin() {
      const roleSelect = document.getElementById('localRole').value;
      const password = document.getElementById('localPassword').value;
      
      if (roleSelect === 'owner' && password === state.meta.ownerPass) {
        role = 'owner';
        localStorage.setItem('localRole', 'owner');
        closeLoginModal();
        toast('–í—Ö–æ–¥ –∫–∞–∫ –í–ª–∞–¥–µ–ª–µ—Ü');
        updateUI();
        renderAll();
      } else if (roleSelect === 'admin' && password === state.meta.adminPass) {
        role = 'admin';
        localStorage.setItem('localRole', 'admin');
        closeLoginModal();
        toast('–í—Ö–æ–¥ –∫–∞–∫ –ê–¥–º–∏–Ω');
        updateUI();
        renderAll();
      } else {
        toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', true);
      }
    }

    function logout() {
      if (auth && currentUser) auth.signOut();
      role = 'guest';
      currentUser = null;
      localStorage.removeItem('localRole');
      toast('–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
      updateUI();
      renderAll();
    }

    // Tribe editing
    function openEditTribe(id) {
      if (!canEditState()) return toast('–ù–µ—Ç –ø—Ä–∞–≤', true);
      
      const player = state.players.find(p => p.id === id);
      if (!player) return;
      
      document.getElementById('editTribeId').value = id;
      document.getElementById('editTribeName').value = player.name;
      document.getElementById('editTribeArmy').value = player.army;
      document.getElementById('editTribePop').value = player.pop;
      document.getElementById('editTribeTerr').value = player.territories;
      document.getElementById('editTribeHappy').value = player.happy;
      document.getElementById('editTribeEnergy').value = player.energy || 0;
      
      const modal = document.getElementById('editTribeModal');
      modal.classList.remove('hidden');
      setTimeout(() => modal.querySelector('.modal-backdrop').classList.add('show'), 10);
    }

    function closeEditTribeModal() {
      const modal = document.getElementById('editTribeModal');
      modal.querySelector('.modal-backdrop').classList.remove('show');
      setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function saveTribe() {
      const id = parseInt(document.getElementById('editTribeId').value);
      const player = state.players.find(p => p.id === id);
      if (!player) return;
      
      player.name = document.getElementById('editTribeName').value;
      player.army = parseInt(document.getElementById('editTribeArmy').value) || 0;
      player.pop = parseInt(document.getElementById('editTribePop').value) || 0;
      player.territories = parseInt(document.getElementById('editTribeTerr').value) || 0;
      player.happy = Math.min(100, Math.max(0, parseInt(document.getElementById('editTribeHappy').value) || 0));
      player.energy = Math.min(100, Math.max(0, parseInt(document.getElementById('editTribeEnergy').value) || 0));
      
      saveState();
      closeEditTribeModal();
      renderAll();
      toast('–ü–ª–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
    }

    function deleteTribe() {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø–ª–µ–º—è?')) return;
      const id = parseInt(document.getElementById('editTribeId').value);
      state.players = state.players.filter(p => p.id !== id);
      saveState();
      closeEditTribeModal();
      renderAll();
      toast('–ü–ª–µ–º—è —É–¥–∞–ª–µ–Ω–æ');
    }

    function openAddTribeModal() {
      const id = Date.now();
      state.players.push({ id, name: '–ù–æ–≤–æ–µ –ø–ª–µ–º—è', army: 0, pop: 5, territories: 0, happy: 50, energy: 50 });
      saveState();
      renderAll();
      openEditTribe(id);
    }

    // Rule editing
    function openEditRule(id) {
      if (!canEditState()) return toast('–ù–µ—Ç –ø—Ä–∞–≤', true);
      
      const rule = state.rules.find(r => r.id === id);
      if (!rule) return;
      
      document.getElementById('editRuleId').value = id;
      document.getElementById('editRuleIcon').value = rule.icon;
      document.getElementById('editRuleTitleInput').value = rule.title;
      document.getElementById('editRuleContent').value = rule.content;
      document.getElementById('editRuleTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞';
      document.getElementById('deleteRuleBtn').classList.remove('hidden');
      
      const modal = document.getElementById('editRuleModal');
      modal.classList.remove('hidden');
      setTimeout(() => modal.querySelector('.modal-backdrop').classList.add('show'), 10);
    }

    function openAddRuleModal() {
      if (!canEditState()) return toast('–ù–µ—Ç –ø—Ä–∞–≤', true);
      
      document.getElementById('editRuleId').value = '';
      document.getElementById('editRuleIcon').value = 'üìù';
      document.getElementById('editRuleTitleInput').value = '';
      document.getElementById('editRuleContent').value = '';
      document.getElementById('editRuleTitle').textContent = '–ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª';
      document.getElementById('deleteRuleBtn').classList.add('hidden');
      
      const modal = document.getElementById('editRuleModal');
      modal.classList.remove('hidden');
      setTimeout(() => modal.querySelector('.modal-backdrop').classList.add('show'), 10);
    }

    function closeEditRuleModal() {
      const modal = document.getElementById('editRuleModal');
      modal.querySelector('.modal-backdrop').classList.remove('show');
      setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function saveRule() {
      const id = document.getElementById('editRuleId').value;
      const icon = document.getElementById('editRuleIcon').value || 'üìù';
      const title = document.getElementById('editRuleTitleInput').value;
      const content = document.getElementById('editRuleContent').value;
      
      if (!title) return toast('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫', true);
      
      if (id) {
        const rule = state.rules.find(r => r.id === id);
        if (rule) {
          rule.icon = icon;
          rule.title = title;
          rule.content = content;
        }
      } else {
        state.rules.push({
          id: 'rule_' + Date.now(),
          icon,
          title,
          content
        });
      }
      
      saveState();
      closeEditRuleModal();
      renderRules();
      toast('–†–∞–∑–¥–µ–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    }

    function deleteRule() {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª?')) return;
      const id = document.getElementById('editRuleId').value;
      state.rules = state.rules.filter(r => r.id !== id);
      saveState();
      closeEditRuleModal();
      renderRules();
      toast('–†–∞–∑–¥–µ–ª —É–¥–∞–ª—ë–Ω');
    }

    // Admin functions
    function giveEnergyAll() {
      if (!canEditState()) return;
      state.players.forEach(p => p.energy = Math.min(100, (p.energy || 0) + 15));
      saveState();
      renderAll();
      toast('+15 —ç–Ω–µ—Ä–≥–∏–∏ –≤—Å–µ–º –ø–ª–µ–º–µ–Ω–∞–º');
    }

    function randomEvent() {
      if (!canEditState()) return;
      const events = [
        { name: '–ü–æ–∂–∞—Ä', effect: () => state.players.forEach(p => p.happy = Math.max(0, p.happy - 10)) },
        { name: '–≠–ø–∏–¥–µ–º–∏—è', effect: () => state.players.forEach(p => p.pop = Math.max(1, p.pop - 1)) },
        { name: '–•–æ—Ä–æ—à–∏–π —É—Ä–æ–∂–∞–π', effect: () => state.players.forEach(p => p.happy = Math.min(100, p.happy + 5)) },
        { name: '–ù–∞–±–µ–≥', effect: () => state.players.forEach(p => p.army = Math.max(0, p.army - 2)) },
      ];
      const event = events[Math.floor(Math.random() * events.length)];
      event.effect();
      saveState();
      renderAll();
      toast('–°–æ–±—ã—Ç–∏–µ: ' + event.name);
    }

    async function saveToCloud() {
      if (!db) return toast('Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', true);
      if (!canEditState()) return toast('–ù–µ—Ç –ø—Ä–∞–≤', true);
      
      try {
        state.updatedAt = Date.now();
        await db.collection('site').doc('state').set(state);
        saveState();
        toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ!');
      } catch (e) {
        toast('–û—à–∏–±–∫–∞: ' + e.message, true);
      }
    }

    async function loadFromCloud() {
      if (!db) return toast('Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', true);
      
      try {
        const snap = await db.collection('site').doc('state').get();
        if (snap.exists) {
          state = snap.data();
          saveState();
          renderAll();
          toast('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –æ–±–ª–∞–∫–∞');
        } else {
          toast('–í –æ–±–ª–∞–∫–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö', true);
        }
      } catch (e) {
        toast('–û—à–∏–±–∫–∞: ' + e.message, true);
      }
    }

    async function setAsOwner() {
      if (!currentUser) return toast('–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google', true);
      state.meta.ownerUid = currentUser.uid;
      state.meta.ownerName = currentUser.displayName || currentUser.email;
      saveState();
      await saveToCloud();
      updateUI();
      toast('–í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –≤–ª–∞–¥–µ–ª—å—Ü–µ–º');
    }

    function addAdmin() {
      const uid = document.getElementById('newAdminInput').value.trim();
      if (!uid) return toast('–í–≤–µ–¥–∏—Ç–µ UID', true);
      if (!state.meta.admins) state.meta.admins = [];
      if (!state.meta.admins.includes(uid)) {
        state.meta.admins.push(uid);
        saveState();
        toast('–ê–¥–º–∏–Ω –¥–æ–±–∞–≤–ª–µ–Ω');
      }
    }

    function exportData() {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'nova-zemlya-backup.json';
      a.click();
      URL.revokeObjectURL(url);
      toast('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
    }

    function resetMap() {
      if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –∫–∞—Ä—Ç—É?')) return;
      state.map = { dataUrl: '', name: '', updatedAt: null };
      saveState();
      renderMap();
      toast('–ö–∞—Ä—Ç–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      loadState();
      
      const savedRole = localStorage.getItem('localRole');
      if (savedRole) role = savedRole;
      
      renderAll();

      document.getElementById('mapUpload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = () => {
          state.map = { dataUrl: reader.result, name: file.name, updatedAt: Date.now() };
          saveState();
          renderMap();
          toast('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        };
        reader.readAsDataURL(file);
        e.target.value = '';
      });

      document.getElementById('importFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            if (data.players) {
              state = data;
              saveState();
              renderAll();
              toast('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
            }
          } catch (e) {
            toast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞', true);
          }
        };
        reader.readAsText(file);
        e.target.value = '';
      });

      if (auth) {
        auth.onAuthStateChanged(async (user) => {
          currentUser = user;
          if (user) {
            try {
              const snap = await db.collection('site').doc('state').get();
              if (snap.exists) {
                const cloud = snap.data();
                if (!state.updatedAt || (cloud.updatedAt && cloud.updatedAt > state.updatedAt)) {
                  state = cloud;
                  saveState();
                  renderAll();
                }
              }
            } catch (e) {}
            
            db.collection('site').doc('state').onSnapshot((snap) => {
              if (snap.exists) {
                const cloud = snap.data();
                if (cloud.updatedAt && cloud.updatedAt > state.updatedAt) {
                  state = cloud;
                  saveState();
                  renderAll();
                  toast('–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
                }
              }
            });
          }
          updateUI();
          renderAll();
        });
      }
    });
  </script>
</body>
</html>
