<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ù–æ–≤–∞—è –ó–µ–º–ª—è ‚Äî –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∏ –∞–¥–º–∏–Ω–∫–∞</title>
  <meta name="description" content="–ù–æ–≤–∞—è –ó–µ–º–ª—è ‚Äî –∫–∞—Ä—Ç–∞, –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º, —Ç–æ–ø—ã –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#071127;
      --card:#0b1220;
      --accent:#6ee7b7;
      --accent2:#60a5fa;
      --muted:#9aa4b2;
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
    }
    *{box-sizing:border-box}
    body{
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      margin:0;
      background:linear-gradient(180deg,var(--bg),#071827);
      color:#e6eef6;
      -webkit-font-smoothing:antialiased;
    }
    .container{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#022}
    h1{margin:0;font-size:20px}
    .nav-buttons{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:inherit;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease,opacity .18s}
    button:active{transform:translateY(1px)}
    button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#022;border:none}
    .hero{display:grid;grid-template-columns:1fr 380px;gap:18px;margin-top:18px}
    .card{background:linear-gradient(180deg,var(--glass-2), rgba(255,255,255,0.01));padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 24px rgba(2,6,23,0.55);transition:transform .22s ease,opacity .22s ease;}
    .card:hover{transform:translateY(-4px)}
    .welcome{padding:22px}
    .muted{color:var(--muted);font-size:14px}
    .map-area img{width:100%;height:auto;border-radius:10px;display:block}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tabs{display:flex;gap:8px;margin-top:12px}
    .tab{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
    .grids{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px}
    table{width:100%;border-collapse:collapse}
    td,th{padding:6px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:14px}
    th{font-weight:600}
    .accordion-list{display:flex;flex-direction:column;gap:8px}
    .accordion-item{border-radius:10px;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
    .accordion-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;cursor:pointer;user-select:none}
    .accordion-head .title{display:flex;gap:10px;align-items:center}
    .accordion-body{padding:0 14px 14px 14px;max-height:0;overflow:hidden;transition:max-height .36s cubic-bezier(.2,.9,.2,1),opacity .28s ease;opacity:0}
    .accordion-body.open{opacity:1}
    .accordion-body-inner{padding-top:12px}
    .accordion-actions{display:flex;gap:8px;margin-top:8px}
    footer{margin-top:24px;text-align:center;color:var(--muted);font-size:13px}
    .badge{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.04);font-weight:600}
    .small{font-size:13px;color:var(--muted)}
    .editor{border:1px dashed rgba(255,255,255,0.04);padding:8px;border-radius:8px;min-height:44px;outline:none}
    .hidden{display:none!important}
    .uploader{display:flex;gap:6px;align-items:center}
    input[type=file]{display:none}
    .toast{position:fixed;right:20px;bottom:20px;background:#0b1220;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);display:none}
    .flex{display:flex;gap:8px;align-items:center}
    .admin-only{display:none}
    .admin-badge{background:rgba(110,231,183,0.12);color:#042;padding:4px 8px;border-radius:999px;font-weight:700}
    .modal-back{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:#071827;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);min-width:320px;color:inherit}
    .row{display:flex;gap:8px;align-items:center}
    .col{display:flex;flex-direction:column;gap:8px}
    .input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .btn-ghost{background:transparent;border:1px dashed rgba(255,255,255,0.04)}
    .fade-in{animation:fadeIn .36s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    @media(max-width:980px){.hero{grid-template-columns:1fr} .grids{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">NZ</div>
        <div>
          <h1>–ù–æ–≤–∞—è –ó–µ–º–ª—è</h1>
          <div class="small muted">–°–∏—Å—Ç–µ–º–∞ –ø–ª–µ–º–µ–Ω–∏ ‚Äî –∫–∞—Ä—Ç–∞, —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏ –∞–¥–º–∏–Ω–∫–∞</div>
        </div>
      </div>

      <div class="nav-buttons">
        <div id="roleBadge" class="badge">–ì–æ—Å—Ç—å</div>
        <button onclick="showSection('map')">–ö–∞—Ä—Ç–∞</button>
        <button onclick="showSection('explain')">–û–±—ä—è—Å–Ω–µ–Ω–∏–µ</button>
        <button onclick="showSection('tops')">–¢–æ–ø—ã</button>

        <button id="localLoginBtn">–í–æ–π—Ç–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
        <button class="primary" id="signinBtn">–í–æ–π—Ç–∏ (Google)</button>
        <button id="signoutBtn" class="hidden">–í—ã–π—Ç–∏</button>
      </div>
    </header>

    <main class="hero">
      <section class="card welcome fade-in" id="section-welcome">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ¬´–ù–æ–≤—É—é –ó–µ–º–ª—é¬ª</h2>
        <p class="muted">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø–ª–µ–º—è, —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —ç–Ω–µ—Ä–≥–∏–µ–π, –∏—Å—Å–ª–µ–¥—É–π—Ç–µ –∫–∞—Ä—Ç—É –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–π—Ç–µ —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏. –ü—Ä–∞–≤–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ ‚Äî —Ç–æ–≥–¥–∞ –æ–Ω–∏ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –≤—Å–µ–º.</p>

        <div class="controls">
          <button onclick="showSection('map')">–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</button>
          <button onclick="showSection('tops')">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–ø—ã</button>
          <button onclick="showSection('explain')">–û–±—ä—è—Å–Ω–µ–Ω–∏–µ</button>
          <button onclick="scrollTo('#admin')">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
        </div>

        <div class="tabs">
          <div class="tab" onclick="quickAction('giveEnergyAll')">+20 ‚ö° –≤—Å–µ–º (–¥–µ–º–æ)</div>
          <div class="tab" onclick="quickAction('randomEvent')">–°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ</div>
        </div>

        <div style="margin-top:12px" id="welcomeText" class="small editor" contenteditable="false" title="–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –∫–∞–∫ –∞–¥–º–∏–Ω">
          <strong>–ù–æ–≤–∞—è –ó–µ–º–ª—è</strong> ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–≥—Ä—ã –≤ Telegram: –∫–∞—Ä—Ç–∞, –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º, —Ç–æ–ø—ã –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
        </div>
      </section>

      <aside class="card map-area fade-in">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>–ö–∞—Ä—Ç–∞</strong>
          <div class="small muted">PNG/JPG. –ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –∫–∞—Ä—Ç—É ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ; –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚Äî –≤ –æ–±–ª–∞–∫–æ.</div>
        </div>

        <div style="margin-top:10px">
          <label class="uploader">
            <input id="mapFile" type="file" accept="image/*">
            <button onclick="document.getElementById('mapFile').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É</button>
          </label>
          <button onclick="resetMap()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>

        <div style="margin-top:12px">
          <img id="mapPreview" src="" alt="–ö–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞" style="display:none;border-radius:8px;max-height:420px;object-fit:contain;width:100%;">
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="togglePublicEditBtn">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
          <button onclick="downloadLocalBackup()">–≠–∫—Å–ø–æ—Ä—Ç –ª–æ–∫–∞–ª—å–Ω–æ</button>
          <label>
            <input type="file" id="importFile" accept="application/json" style="display:none">
            <button onclick="document.getElementById('importFile').click()">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
          </label>
        </div>

        <div class="small muted" style="margin-top:8px">–ï—Å–ª–∏ Firebase –≤–∫–ª—é—á—ë–Ω –∏ –≤—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω/–≤–ª–∞–¥–µ–ª–µ—Ü ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —á—Ç–æ–±—ã –æ–Ω–∏ —Å—Ç–∞–ª–∏ –≤–∏–¥–Ω—ã –≤—Å–µ–º.</div>
      </aside>
    </main>

    <!-- –ö–∞—Ä—Ç–∞ / –ú–∞—Ä–∫–µ—Ä—ã -->
    <div id="section-map" class="card fade-in" style="margin-top:14px;display:none;">
      <h3>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</h3>
      <p class="muted">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–ª–µ–º—è, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤.</p>
      <div id="mapMarkers" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px"></div>
    </div>

    <!-- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ / –°–∏—Å—Ç–µ–º—ã –ø–ª–µ–º–µ–Ω–∏ -->
    <div id="section-explain" class="card fade-in" style="margin-top:14px;display:none;">
      <h3>ü™® –°–ò–°–¢–ï–ú–´ –ü–õ–ï–ú–ï–ù–ò (–î–†–ï–í–ù–ò–ï –í–†–ï–ú–ï–ù–ê)</h3>
      <div class="small muted">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø–æ–¥–ø—É–Ω–∫—Ç, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ. –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –æ–±–ª–∞–∫–æ.</div>

      <div style="margin-top:12px" class="accordion-list" id="explainAccordion">
        <!-- We'll populate accordion items dynamically from JS -->
      </div>
    </div>

    <!-- Tops -->
    <div id="section-tops" class="card fade-in" style="margin-top:14px;display:none;">
      <h3>–¢–æ–ø—ã –ø–ª–µ–º–µ–Ω</h3>
      <div class="grids">
        <div class="list card">
          <h4>–ü–æ –∞—Ä–º–∏–∏</h4>
          <table id="topArmy"><thead><tr><th>#</th><th>–ü–ª–µ–º—è</th><th>–ê—Ä–º–∏—è</th><th></th></tr></thead><tbody></tbody></table>
        </div>
        <div class="list card">
          <h4>–ü–æ –Ω–∞—Å–µ–ª–µ–Ω–∏—é</h4>
          <table id="topPop"><thead><tr><th>#</th><th>–ü–ª–µ–º—è</th><th>–ù–∞—Å–µ–ª–µ–Ω–∏–µ</th><th></th></tr></thead><tbody></tbody></table>
        </div>
        <div class="list card">
          <h4>–ü–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è–º</h4>
          <table id="topTerr"><thead><tr><th>#</th><th>–ü–ª–µ–º—è</th><th>–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</th><th></th></tr></thead><tbody></tbody></table>
        </div>
        <div class="list card">
          <h4>–ü–æ —Å—á–∞—Å—Ç—å—é</h4>
          <table id="topHappy"><thead><tr><th>#</th><th>–ü–ª–µ–º—è</th><th>–°—á–∞—Å—Ç—å–µ</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <!-- Admin panel -->
    <div id="admin" class="card admin-only" style="margin-top:14px;">
      <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å <span id="adminBadge" class="admin-badge">Admin</span></h3>
      <div class="small muted">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º/–≤–ª–∞–¥–µ–ª—å—Ü—É.</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
        <div class="card">
          <h4>–ë—ã—Å—Ç—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h4>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button onclick="giveEnergyToSelected(20)">+20 ‚ö° –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É</button>
            <button onclick="modifyTax(15)">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ª–æ–≥–∏ +15 ‚ö°</button>
            <button onclick="randomEvent()">–°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ</button>
            <button onclick="addDemoPlayer()">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç-–ø–ª–µ–º—è</button>
            <button onclick="bulkEditPrompt()">–ú–∞—Å—Å–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
          </div>
        </div>

        <div class="card">
          <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
          <div class="col">
            <div>–í–ª–∞–¥–µ–ª–µ—Ü: <span id="ownerInfo" class="small muted">–Ω–µ –∑–∞–¥–∞–Ω</span></div>
            <div class="row">
              <button onclick="setAsOwner()">–°–¥–µ–ª–∞—Ç—å –º–µ–Ω—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º (cloud)</button>
              <button onclick="assignLocalOwner()">–°–¥–µ–ª–∞—Ç—å –º–µ–Ω—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
            </div>
            <div class="row">
              <input id="newAdminUid" class="input" placeholder="UID –¥–ª—è –∞–¥–º–∏–Ω–∞ (Firebase UID)" />
              <button onclick="addAdminByUid()">–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞</button>
            </div>
            <div class="row">
              <button onclick="changeLocalPasswords()">–ü–æ–º–µ–Ω—è—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏</button>
              <button onclick="resetToDefault()">–°–±—Ä–æ—Å –≤ –¥–µ—Ñ–æ–ª—Ç</button>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <h4>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h4>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button onclick="downloadLocalBackup()">–≠–∫—Å–ø–æ—Ä—Ç –ª–æ–∫–∞–ª—å–Ω–æ (JSON)</button>
          <button onclick="onImportClick()">–ò–º–ø–æ—Ä—Ç (JSON)</button>
          <button onclick="forceSave()" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ–π—á–∞—Å (–ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ cloud)</button>
          <button onclick="pushLocalToCloud()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≤ –æ–±–ª–∞–∫–æ)</button>
        </div>
        <div id="lastSaved" class="small muted" style="margin-top:8px"></div>
      </div>
    </div>

    <footer>
      –°–¥–µ–ª–∞–Ω–æ –¥–ª—è ¬´–ù–æ–≤–æ–π –ó–µ–º–ª–∏¬ª. –î–ª—è –ø—É–±–ª–∏—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Firebase –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
    </footer>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Modal for local login -->
  <div id="modalLogin" class="modal-back hidden" style="display:none">
    <div class="modal">
      <h3>–õ–æ–∫–∞–ª—å–Ω—ã–π –≤—Ö–æ–¥</h3>
      <div class="col">
        <select id="localRoleSelect" class="input"><option value="admin">–ê–¥–º–∏–Ω</option><option value="owner">–í–ª–∞–¥–µ–ª–µ—Ü</option></select>
        <input id="localPassword" class="input" placeholder="–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å" />
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
          <button class="primary" onclick="localLogin()">–í–æ–π—Ç–∏</button>
        </div>
        <div class="small muted">–õ–æ–∫–∞–ª—å–Ω—ã–π –≤—Ö–æ–¥ ‚Äî —É–¥–æ–±–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞. –î–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Å–∞–π—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Google/Firebase Auth.</div>
      </div>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
  /**************************************************************************
   * CONFIGURATION: –≤—Å—Ç–∞–≤–ª–µ–Ω –≤–∞—à Firebase-–∫–æ–Ω—Ñ–∏–≥ (–∫–∞–∫ –≤—ã –ø—Ä–æ—Å–∏–ª–∏)
   * FIREBASE_ENABLED = true ‚Äî —Ä–µ–∂–∏–º –æ–±–ª–∞–∫–∞ –≤–∫–ª—é—á—ë–Ω.
   **************************************************************************/
  const FIREBASE_ENABLED = true;
  const firebaseConfig = {
    apiKey: "AIzaSyCscnMBP6XVMdFRo7TPbn6qmQRtJ045f9I",
    authDomain: "new-earth-cd366.firebaseapp.com",
    projectId: "new-earth-cd366",
    storageBucket: "new-earth-cd366.firebasestorage.app",
    messagingSenderId: "346630323608",
    appId: "1:346630323608:web:135d4fd9118404f62e3fed",
    measurementId: "G-N6BN0H0R9L"
  };

  /******************************* DATA MODEL ********************************/
  const STORAGE_KEY = 'nova_zemlya_data_v4';
  const defaultData = {
    meta: {
      ownerName: '–í–ª–∞–¥–µ–ª–µ—Ü',
      ownerPass: 'owner123',
      adminPass: 'admin123',
      publicEdit: false,
      ownerUid: null,
      admins: []
    },
    map: { dataUrl:'', name:'' },
    players: [
      {id:1,name:'–ú–ï–¢–ê–ú–§–ò–õ–ï–ù–î',army:0,pop:7,territories:24,happy:50,energy:50},
      {id:2,name:'–°–Ω—é—Å–õ–µ–Ω–¥',army:0,pop:7,territories:0,happy:50,energy:50}
    ],
    explain: {}, // dynamic blocks for explanation text
    updatedAt: Date.now()
  };

  // runtime
  let state = loadStateLocal();
  let role = 'guest';
  let currentUser = null;
  let firebaseApp=null, auth=null, db=null, storage=null, unsubscribe=null;
  let lastMapFile = null; // store File object until confirmed to upload to storage

  // Initialize Firebase
  if(FIREBASE_ENABLED && firebaseConfig && firebaseConfig.apiKey){
    try {
      firebaseApp = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      storage = firebase.storage();
      auth.onAuthStateChanged(async user=>{
        currentUser = user;
        if(user){
          document.getElementById('signinBtn').innerText = '–í–æ–π—Ç–∏ –∫–∞–∫: ' + (user.displayName || user.email);
          document.getElementById('signoutBtn').classList.remove('hidden');
          await subscribeCloud();
        } else {
          document.getElementById('signinBtn').innerText = '–í–æ–π—Ç–∏ (Google)';
          document.getElementById('signoutBtn').classList.add('hidden');
          if(unsubscribe){ unsubscribe(); unsubscribe=null; }
          state = loadStateLocal();
          role = 'guest';
          renderAll();
          updateVisibility();
        }
      });
    } catch(e){ console.error('Firebase init error', e); toast('Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ'); updateVisibility(); }
  } else {
    updateVisibility();
  }

  /* ---------------- local storage helpers ---------------- */
  function loadStateLocal(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData)); return JSON.parse(JSON.stringify(defaultData)); }
    try{ const parsed = JSON.parse(raw); // ensure explain blocks exist
      parsed.explain = parsed.explain || {};
      return parsed;
    } catch(e){ localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData)); return JSON.parse(JSON.stringify(defaultData)); }
  }
  function saveStateLocal(){ state.updatedAt = Date.now(); localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); renderAll(); updateLastSaved(); }

  /* ---------------- cloud helpers ---------------- */
  async function subscribeCloud(){
    if(!db) return;
    const ref = db.collection('site').doc('state');
    const snap = await ref.get();
    if(!snap.exists){ await ref.set(state); }
    unsubscribe = ref.onSnapshot(snap=>{
      if(!snap.exists) return;
      const cloud = snap.data();
      if(!state.updatedAt || (cloud.updatedAt && cloud.updatedAt > state.updatedAt)){
        state = cloud;
        saveStateLocal(); // persist locally
        toast('–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞');
      }
      renderAll();
      updateVisibility();
    });
    // set role based on uid
    role = 'guest';
    if(currentUser && state.meta){
      if(state.meta.ownerUid && currentUser.uid === state.meta.ownerUid) role='owner';
      else if(Array.isArray(state.meta.admins) && state.meta.admins.includes(currentUser.uid)) role='admin';
    }
    updateVisibility();
  }

  async function saveStateCloud(){
    if(!db) return saveStateLocal();
    if(!canEditCloud()){ toast('–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –æ–±–ª–∞–∫–æ'); return; }
    const ref = db.collection('site').doc('state');
    state.updatedAt = Date.now();
    await ref.set(state);
    saveStateLocal();
    toast('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–µ');
    updateLastSaved();
  }

  function canEditCloud(){
    if(!currentUser || !state.meta) return false;
    if(state.meta.ownerUid && currentUser.uid === state.meta.ownerUid) return true;
    if(Array.isArray(state.meta.admins) && state.meta.admins.includes(currentUser.uid)) return true;
    return false;
  }

  function canEdit(){
    if(FIREBASE_ENABLED && db && currentUser) return canEditCloud();
    if(role==='owner' || role==='admin') return true;
    return state.meta && state.meta.publicEdit === true;
  }

  /* ---------------- UI / rendering ---------------- */
  function toast(text, timeout=3000){
    const t=document.getElementById('toast'); t.innerText=text; t.style.display='block';
    setTimeout(()=>t.style.display='none', timeout);
  }

  function renderAll(){ renderMap(); renderMarkers(); renderTops(); renderExplain(); updateOwnerInfo(); updateVisibility(); updateLastSaved(); }

  function renderMap(){
    const img=document.getElementById('mapPreview');
    if(state.map && state.map.dataUrl){ img.src=state.map.dataUrl; img.style.display='block'; }
    else img.style.display='none';
  }

  function renderMarkers(){
    const wrap=document.getElementById('mapMarkers'); if(!wrap) return; wrap.innerHTML=''; const can=canEdit();
    (state.players||[]).forEach(p=>{
      const el=document.createElement('div'); el.className='card';
      el.innerHTML = `
        <strong>${escapeHtml(p.name)}</strong>
        <div class="small">–ê—Ä–º–∏—è: ${p.army} ‚Ä¢ –ü–æ–ø: ${p.pop} ‚Ä¢ –¢–µ—Ä—Ä: ${p.territories} ‚Ä¢ –°—á–∞—Å—Ç—å–µ: ${p.happy}%</div>
        <div style="margin-top:8px;display:flex;gap:6px">
          <button onclick="selectPlayer(${p.id})">–í—ã–±—Ä–∞—Ç—å</button>
          ${can?`<button onclick="openEditPlayer(${p.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>`:''}
        </div>`;
      wrap.appendChild(el);
    });
  }

  function renderTops(){ renderTable('topArmy','army'); renderTable('topPop','pop'); renderTable('topTerr','territories'); renderTable('topHappy','happy'); }
  function renderTable(elId,key){
    const tbody=document.getElementById(elId).querySelector('tbody'); tbody.innerHTML=''; const arr=[...state.players].sort((a,b)=>b[key]-a[key]).slice(0,12); const can=canEdit();
    arr.forEach((p,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${escapeHtml(p.name)}</td><td>${p[key]}</td><td>${can?'<button onclick="editRow('+p.id+')">‚úèÔ∏è</button>':''}</td>`; tbody.appendChild(tr); });
  }

  function updateOwnerInfo(){ const ownerSpan=document.getElementById('ownerInfo'); if(state.meta && state.meta.ownerName) ownerSpan.innerText = state.meta.ownerName + (state.meta.publicEdit ? ' ‚Ä¢ –ø—É–±–ª–∏—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –í–ö–õ' : ' ‚Ä¢ –ø—É–±–ª–∏—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –í–´–ö–õ'); else ownerSpan.innerText='–Ω–µ –∑–∞–¥–∞–Ω'; }
  function updateVisibility(){
    const adminPanel=document.getElementById('admin');
    if(canEdit()){ adminPanel.style.display='block'; adminPanel.classList.remove('admin-only'); } else { adminPanel.style.display='none'; adminPanel.classList.add('admin-only'); }
    document.getElementById('roleBadge').innerText = role==='guest' ? '–ì–æ—Å—Ç—å' : (role==='admin' ? '–ê–¥–º–∏–Ω' : '–í–ª–∞–¥–µ–ª–µ—Ü');
    if(currentUser){ document.getElementById('signinBtn').classList.add('hidden'); document.getElementById('signoutBtn').classList.remove('hidden'); }
    else { document.getElementById('signinBtn').classList.remove('hidden'); document.getElementById('signoutBtn').classList.add('hidden'); }
    // enable editing of welcomeText
    const welcome = document.getElementById('welcomeText');
    welcome.contentEditable = canEdit();
    welcome.title = canEdit() ? '–ö–ª–∏–∫–Ω–∏—Ç–µ —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" –¥–ª—è –æ–±–ª–∞–∫–∞.' : '';
  }

  function escapeHtml(s){ if(s===undefined || s===null) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  /* ---------------- explain (accordion) rendering & editing ---------------- */
  // Default blocks (used if state.explain empty)
  const defaultExplainBlocks = [
    { id:'energy', title:'üîã –≠–ù–ï–†–ì–ò–Ø –ü–õ–ï–ú–ï–ù–ò', summary:'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –º–∞–∫—Å–∏–º—É–º', content:
`‚è±Ô∏è –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç –ø–ª–µ–º—è –ø–æ–ª—É—á–∞–µ—Ç 15 —ç–Ω–µ—Ä–≥–∏–∏.
üîí –ú–∞–∫—Å–∏–º—É–º —ç–Ω–µ—Ä–≥–∏–∏: 100 (–º–æ–∂–µ—Ç –ø–æ–≤—ã—à–∞—Ç—å—Å—è —Å —Ä–∞–∑–≤–∏—Ç–∏–µ–º –ø–ª–µ–º–µ–Ω–∏).
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ, —Ä–∞–∑–≤–µ–¥–∫—É, –ø–æ—Ö–æ–¥—ã –∏ –Ω–∞–±–æ—Ä –≤–æ–π—Å–∫–∞.` },
    { id:'spend', title:'üõñ –†–ê–°–•–û–î –≠–ù–ï–†–ì–ò–ò', summary:'–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ, —Ä–∞–∑–≤–µ–¥–∫–∞, –≤–æ–π—Å–∫–æ', content:
`ü™µ –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∏ –±—ã—Ç
‚Ä¢ –£–ª—É—á—à–µ–Ω–∏–µ –ø–æ—Å–µ–ª–µ–Ω–∏—è ‚Äî 10 —ç–Ω–µ—Ä–≥–∏–∏

üó∫ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
‚Ä¢ –†–∞–∑–≤–µ–¥–∫–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ ‚Äî 10‚Äì80 —ç–Ω–µ—Ä–≥–∏–∏
‚Ä¢ –ó–∞—Ö–≤–∞—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ ‚Äî 20‚Äì80 —ç–Ω–µ—Ä–≥–∏–∏
‚Ä¢ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–∑–≤–µ–¥—á–∏–∫–æ–≤ ‚Äî 25 —ç–Ω–µ—Ä–≥–∏–∏
‚Ä¢ –î–∞–ª—å–Ω–∏–π –ø–æ—Ö–æ–¥ ‚Äî 45 —ç–Ω–µ—Ä–≥–∏–∏

üó° –í–æ–π—Å–∫–æ –∏ –∑–∞—â–∏—Ç–∞
‚Ä¢ 5 –≤–æ–∏–Ω–æ–≤ ‚Äî 10 —ç–Ω–µ—Ä–≥–∏–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ø—É–ª—è—Ü–∏—è ‚â•10)
‚Ä¢ –°—Ç–µ–Ω–∞/—á–∞—Å—Ç–æ–∫–æ–ª ‚Äî 35 —ç–Ω–µ—Ä–≥–∏–∏` },
    { id:'research', title:'üß† –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø (–ü–†–ò–ú–ò–¢–ò–í–ù–´–ï –¢–ï–•–ù–û–õ–û–ì–ò–ò)', summary:'–£—Ä–æ–≤–Ω–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å', content:
`ü™ì –£–ª—É—á—à–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:
I ‚Äî 25 ‚ö°, II ‚Äî 50 ‚ö°, III ‚Äî 90 ‚ö°

üõ† –°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ–º–µ—Å–ª–æ:
I ‚Äî 20 ‚ö°, II ‚Äî 40 ‚ö°, III ‚Äî 70 ‚ö°

üåø –õ–µ–∫–∞—Ä—Å—Ç–≤–æ –∏ —à–∞–º–∞–Ω—Å—Ç–≤–æ:
I ‚Äî 35 ‚ö°, II ‚Äî 70 ‚ö°, III ‚Äî 100 ‚ö°` },
    { id:'storage', title:'üóø –•–†–ê–ù–ò–õ–ò–©–ï –≠–ù–ï–†–ì–ò–ò', summary:'–Å–º–∫–æ—Å—Ç—å –ø–æ —É—Ä–æ–≤–Ω—è–º', content:
`I —É—Ä–æ–≤–µ–Ω—å ‚Äî –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å 100
II —É—Ä–æ–≤–µ–Ω—å ‚Äî –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å 110
III —É—Ä–æ–≤–µ–Ω—å ‚Äî –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å 120` },
    { id:'taxes', title:'üí∞ –ù–ê–õ–û–ì–ò –í –ü–õ–ï–ú–ï–ù–ò', summary:'–£—Ä–æ–≤–Ω–∏ –∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è', content:
`–í–æ–∂–¥—å –º–æ–∂–µ—Ç –≤–≤–æ–¥–∏—Ç—å –Ω–∞–ª–æ–≥–∏ ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é –æ—Ç–¥–∞—á—É —ç–Ω–µ—Ä–≥–∏–∏.

–£—Ä–æ–≤–Ω–∏ –Ω–∞–ª–æ–≥–æ–≤ (–≤ –¥–µ–Ω—å):
‚Ä¢ –ù–∏–∑–∫–∏–µ: +5 ‚ö°, +10% —Å—á–∞—Å—Ç—å—è
‚Ä¢ –°—Ä–µ–¥–Ω–∏–µ: +15 ‚ö°, ‚àí40% —Å—á–∞—Å—Ç—å—è
‚Ä¢ –í—ã—Å–æ–∫–∏–µ: +30 ‚ö°, ‚àí70% —Å—á–∞—Å—Ç—å—è

‚ö†Ô∏è –ß–µ–º –≤—ã—à–µ –Ω–∞–ª–æ–≥–∏ ‚Äî —Ç–µ–º –≤—ã—à–µ —Ä–∏—Å–∫ –≤–æ—Å—Å—Ç–∞–Ω–∏—è.` },
    { id:'happy', title:'üòä –°–ß–ê–°–¢–¨–ï –ü–õ–ï–ú–ï–ù–ò', summary:'–ö–∞–∫ —Å—á–∏—Ç–∞—Ç—å, —à—Ç—Ä–∞—Ñ—ã –∏ –±–æ–Ω—É—Å—ã', content:
`–°—á–∞—Å—Ç—å–µ 0‚Äì100%. –°—Ç–∞—Ä—Ç 50%.
–®—Ç—Ä–∞—Ñ—ã: –∞–∫—Ç–∏–≤–Ω–∞—è –≤–æ–π–Ω–∞ ‚àí5%/–¥–µ–Ω—å, –¥–æ–ª–≥–∞—è (>3 –¥–Ω) ‚àí5%, –Ω–µ—Ö–≤–∞—Ç–∫–∞ –µ–¥—ã ‚àí10%, –ø–ª–æ—Ö–∏–µ —É—Å–ª–æ–≤–∏—è ‚àí5%.
–ë–æ–Ω—É—Å—ã: –Ω–∏–∑–∫–∏–µ –Ω–∞–ª–æ–≥–∏ +10%, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–æ–π–Ω +15%, —Ö–æ—Ä–æ—à–∏–µ —É—Å–ª–æ–≤–∏—è +15%, —Å–≤—è—Ç–∏–ª–∏—â–∞ +10%.` },
    { id:'events', title:'üå™ –ù–ï–û–ñ–ò–î–ê–ù–ù–´–ï –û–ë–°–¢–û–Ø–¢–ï–õ–¨–°–¢–í–ê', summary:'–ü–æ–∂–∞—Ä—ã, —ç–ø–∏–¥–µ–º–∏–∏ –∏ —Ç.–¥.', content:
`–°—Ç–∏—Ö–∏–π–Ω—ã–µ –∏–ª–∏ —Å—é–∂–µ—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è: –ø–æ–∂–∞—Ä—ã, —ç–ø–∏–¥–µ–º–∏–∏, –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏—è ‚Äî —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ —Å—á–∞—Å—Ç—å–µ: ‚àí5‚Ä¶‚àí20% (–≤—Ä–µ–º–µ–Ω–Ω–æ). –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏–π —Å—É–º–º–∏—Ä—É—é—Ç—Å—è.` }
  ];

  function renderExplain(){
    const container = document.getElementById('explainAccordion');
    container.innerHTML = '';
    const blocks = Object.keys(state.explain).length ? Object.values(state.explain) : defaultExplainBlocks;
    blocks.forEach(b=>{
      const item = document.createElement('div'); item.className='accordion-item';
      const head = document.createElement('div'); head.className='accordion-head';
      head.innerHTML = `<div class="title"><div style="font-size:18px">${b.title}</div><div class="small muted">${b.summary||''}</div></div><div class="small muted">–û—Ç–∫—Ä—ã—Ç—å</div>`;
      head.onclick = ()=>{ toggleAccordion(head); };
      const body = document.createElement('div'); body.className='accordion-body';
      const inner = document.createElement('div'); inner.className='accordion-body-inner';
      const contentDiv = document.createElement('div');
      contentDiv.innerHTML = `<div class="small" id="explain-${b.id}">${convertNewlinesToHtml(b.content||'')}</div>`;
      inner.appendChild(contentDiv);

      // actions (edit/save) for admins
      const actions = document.createElement('div'); actions.className='accordion-actions';
      const editBtn = document.createElement('button'); editBtn.className='btn-ghost'; editBtn.innerText='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
      editBtn.onclick = (e)=>{ e.stopPropagation(); openExplainEditor(b.id); };
      actions.appendChild(editBtn);
      inner.appendChild(actions);

      body.appendChild(inner);
      item.appendChild(head);
      item.appendChild(body);
      container.appendChild(item);

      // ensure max-height set for open/close
      // store content in state.explain if not present
      if(!state.explain[b.id]) { state.explain[b.id] = { id:b.id, title:b.title, summary:b.summary, content:b.content }; }
    });
  }

  function convertNewlinesToHtml(txt){ return escapeHtml(txt).replace(/\n/g, '<br>'); }

  function toggleAccordion(head){
    const body = head.nextElementSibling;
    if(!body) return;
    const isOpen = body.style.maxHeight && body.style.maxHeight !== '0px';
    if(isOpen){
      body.style.maxHeight = '0px';
      body.classList.remove('open');
    } else {
      // close others
      document.querySelectorAll('.accordion-body').forEach(b=>{ b.style.maxHeight='0px'; b.classList.remove('open'); });
      // open this
      body.classList.add('open');
      body.style.maxHeight = (body.scrollHeight + 20) + 'px';
    }
  }

  function openExplainEditor(id){
    if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü');
    const block = state.explain[id];
    const newText = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞: ' + (block.title||id), block.content || '');
    if(newText === null) return;
    block.content = newText;
    // update DOM immediately
    const el = document.getElementById('explain-'+id);
    if(el) el.innerHTML = convertNewlinesToHtml(newText);
    saveStateLocal();
    toast('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≤ –æ–±–ª–∞–∫–æ)" —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å.');
  }

  /* ---------------- Map upload (local preview + confirm cloud upload) ---------------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    const mapFile=document.getElementById('mapFile'); if(mapFile) mapFile.addEventListener('change', onMapFileChange);
    const importFile=document.getElementById('importFile'); if(importFile) importFile.addEventListener('change', onImportFileChange);
    document.getElementById('localLoginBtn').addEventListener('click', ()=>openModal());
    document.getElementById('signinBtn').addEventListener('click', ()=>{ if(firebaseAvailable()) signInWithGoogle(); else toast('Firebase –æ—Ç–∫–ª—é—á—ë–Ω'); });
    document.getElementById('signoutBtn').addEventListener('click', ()=>{ if(firebaseAvailable()) auth.signOut(); else localLogout(); });
    // save welcomeText on blur/input
    const welcome = document.getElementById('welcomeText');
    welcome.addEventListener('input', ()=>{ state.welcome = welcome.innerText; saveStateLocal(); });
    welcome.addEventListener('blur', ()=>{ state.welcome = welcome.innerText; saveStateLocal(); });
    renderAll();
    updateLastSaved();
  });

  function firebaseAvailable(){ return FIREBASE_ENABLED && typeof firebase !== 'undefined' && auth; }

  async function onMapFileChange(e){
    const f = e.target.files[0]; if(!f) return;
    lastMapFile = f; // store until confirmed to cloud
    // preview dataURL immediately
    const reader=new FileReader(); reader.onload=()=>{ state.map.dataUrl = reader.result; state.map.name=f.name; renderMap(); saveStateLocal(); };
    reader.readAsDataURL(f);
    e.target.value='';
    toast('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≤ –æ–±–ª–∞–∫–æ)" —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤ Storage.');
  }

  function resetMap(){ state.map = {dataUrl:'',name:''}; lastMapFile = null; saveStateLocal(); renderMap(); toast('–ö–∞—Ä—Ç–∞ —Å–±—Ä–æ—à–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ'); }

  /* ---------------- Players edit ---------------- */
  function selectPlayer(id){ const p=state.players.find(x=>x.id===id); if(!p) return toast('–ü–ª–µ–º—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'); window.selectedPlayer=p; toast('–í—ã–±—Ä–∞–Ω: '+p.name); }
  function editRow(id){ if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü'); openEditPlayer(id); }
  async function openEditPlayer(id){
    if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü');
    const p=state.players.find(x=>x.id===id); if(!p) return;
    const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–º–µ–Ω–∏', p.name); if(name!==null) p.name=name;
    const army=parseInt(prompt('–ê—Ä–º–∏—è', p.army))||p.army;
    const pop=parseInt(prompt('–ù–∞—Å–µ–ª–µ–Ω–∏–µ', p.pop))||p.pop;
    const terr=parseInt(prompt('–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏', p.territories))||p.territories;
    const happy=parseInt(prompt('–°—á–∞—Å—Ç—å–µ (0-100)', p.happy))||p.happy;
    p.army=army; p.pop=pop; p.territories=terr; p.happy=happy;
    saveStateLocal();
    toast('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≤ –æ–±–ª–∞–∫–æ)" —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å.');
  }

  /* ---------------- Admin utils ---------------- */
  function addDemoPlayer(){ if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü'); const id=Date.now(); state.players.push({id,name:'–ù–æ–≤—ã–π_'+id%1000,army:0,pop:5,territories:0,happy:50,energy:50}); saveStateLocal(); }
  function bulkEditPrompt(){ if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü'); const key=prompt('–ü–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –ø—Ä–∞–≤–∫–∏ (name/army/pop/territories/happy)'); if(!key) return; const val=prompt('–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ'); if(val===null) return; state.players.forEach(p=>{ if(key==='name') p.name=val; else p[key]=Number(val)||p[key]; }); saveStateLocal(); toast('–ú–∞—Å—Å–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ'); }
  function modifyTax(n){ if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü'); state.players.forEach(p=>p.happy=Math.max(0,p.happy-Math.round(n/2))); saveStateLocal(); toast('–ù–∞–ª–æ–≥–∏ –∏–∑–º–µ–Ω–µ–Ω—ã (–ª–æ–∫–∞–ª—å–Ω–æ)'); }
  function giveEnergyToSelected(n){ if(!window.selectedPlayer) return toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–ª–µ–º—è'); window.selectedPlayer.energy=Math.min(100,(window.selectedPlayer.energy||0)+n); saveStateLocal(); }
  function randomEvent(){ if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü'); const ev=Math.random(); if(ev<0.33) state.players.forEach(p=>p.happy=Math.max(0,p.happy-5)); else if(ev<0.66) state.players.forEach(p=>p.pop=Math.max(1,p.pop-1)); else state.players.forEach(p=>p.army+=5); saveStateLocal(); toast('–°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ (–ª–æ–∫–∞–ª—å–Ω–æ)'); }
  function resetToDefault(){ if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –¥–µ—Ñ–æ–ª—Ç?')) return; state=JSON.parse(JSON.stringify(defaultData)); saveStateLocal(); toast('–°–±—Ä–æ—à–µ–Ω–æ –≤ –¥–µ—Ñ–æ–ª—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)'); }

  /* ---------------- Export / Import ---------------- */
  function downloadLocalBackup(){
    const data=JSON.stringify(state,null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='nova_zemlya_data.json'; a.click(); URL.revokeObjectURL(url); toast('–≠–∫—Å–ø–æ—Ä—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ –∑–∞–≤–µ—Ä—à—ë–Ω'); 
  }
  function onImportClick(){ document.getElementById('importFile').click(); }
  function onImportFileChange(e){ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=async ()=>{ try{ const obj=JSON.parse(r.result); if(obj && obj.players){ if(!confirm('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –∑–∞–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ?')) return; state=obj; saveStateLocal(); toast('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≤ –æ–±–ª–∞–∫–æ)" –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.'); } else toast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–∞–π–ª'); } catch(err){ toast('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞'); } }; r.readAsText(f); e.target.value=''; }

  /* ---------------- Local auth modal ---------------- */
  function openModal(){ document.getElementById('modalLogin').style.display='flex'; }
  function closeModal(){ document.getElementById('modalLogin').style.display='none'; }
  function localLogin(){
    const roleSel=document.getElementById('localRoleSelect').value;
    const pass=document.getElementById('localPassword').value;
    if(!pass) return toast('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
    const meta=state.meta||{};
    if(roleSel==='owner' && pass===meta.ownerPass){ role='owner'; closeModal(); saveStateLocal(); updateVisibility(); toast('–í—Ö–æ–¥ –∫–∞–∫ –í–ª–∞–¥–µ–ª–µ—Ü (–ª–æ–∫–∞–ª—å–Ω–æ)'); return; }
    if(roleSel==='admin' && pass===meta.adminPass){ role='admin'; closeModal(); saveStateLocal(); updateVisibility(); toast('–í—Ö–æ–¥ –∫–∞–∫ –ê–¥–º–∏–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)'); return; }
    toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å');
  }
  function assignLocalOwner(){ if(!confirm('–ù–∞–∑–Ω–∞—á–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞?')) return; const name=prompt('–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞', state.meta.ownerName||'–í–ª–∞–¥–µ–ª–µ—Ü'); if(!name) return; state.meta.ownerName=name; state.meta.ownerPass=prompt('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞', state.meta.ownerPass||''); saveStateLocal(); toast('–õ–æ–∫–∞–ª—å–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü –Ω–∞–∑–Ω–∞—á–µ–Ω'); }
  function changeLocalPasswords(){ if(!canEdit()) return toast('–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü/–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –ø–∞—Ä–æ–ª–∏'); const op=prompt('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)'); if(op) state.meta.ownerPass=op; const ap=prompt('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)'); if(ap) state.meta.adminPass=ap; saveStateLocal(); toast('–õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã'); }

  /* ---------------- Firebase helpers ---------------- */
  async function signInWithGoogle(){ if(!firebaseAvailable()) return toast('Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'); const provider=new firebase.auth.GoogleAuthProvider(); try{ await auth.signInWithPopup(provider); }catch(e){ console.error(e); toast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google'); } }
  function localLogout(){ role='guest'; currentUser=null; updateVisibility(); toast('–í—ã—à–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ'); }
  function showLastSaved(){ const ls=state.updatedAt?new Date(state.updatedAt).toLocaleString():'–Ω–∏–∫–æ–≥–¥–∞'; document.getElementById('lastSaved').innerText='–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: '+ls; toast('–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞–Ω–æ'); }
  function updateLastSaved(){ if(state.updatedAt) document.getElementById('lastSaved').innerText='–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: '+new Date(state.updatedAt).toLocaleString(); }

  async function setAsOwner(){ if(!firebaseAvailable()||!currentUser) return toast('–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google –∏ –≤–∫–ª—é—á–∏—Ç–µ Firebase'); state.meta.ownerUid=currentUser.uid; state.meta.ownerName=currentUser.displayName||currentUser.email; await saveStateCloud(); toast('–í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –≤–ª–∞–¥–µ–ª—å—Ü–µ–º (–æ–±–ª–∞–∫–æ)'); }
  function addAdminByUid(){ const uid=document.getElementById('newAdminUid').value.trim(); if(!uid) return toast('–í–≤–µ–¥–∏—Ç–µ UID'); state.meta.admins=state.meta.admins||[]; if(!state.meta.admins.includes(uid)) state.meta.admins.push(uid); saveStateLocal(); toast('UID –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∞–¥–º–∏–Ω—ã (–ª–æ–∫–∞–ª—å–Ω–æ). –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≤ –æ–±–ª–∞–∫–æ)" —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–µ.'); }

  /* ---------------- Navigation and helpers ---------------- */
  function showSection(name){
    document.getElementById('section-map').style.display = (name==='map') ? 'block':'none';
    document.getElementById('section-explain').style.display = (name==='explain') ? 'block':'none';
    document.getElementById('section-tops').style.display = (name==='tops') ? 'block':'none';
    if(name==='map') renderMap();
  }
  function scrollTo(sel){ const el=document.querySelector(sel); if(el) el.scrollIntoView({behavior:'smooth'}); }

  /* ---------------- Push local changes to cloud (confirm) ---------------- */
  async function pushLocalToCloud(){
    if(!firebaseAvailable()) return toast('Firebase –æ—Ç–∫–ª—é—á—ë–Ω –∏–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
    if(!currentUser) return toast('–í–æ–π–¥–∏—Ç–µ –≤ Google, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–µ');
    if(!canEditCloud()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –∞–¥–º–∏–Ω/–≤–ª–∞–¥–µ–ª–µ—Ü –≤ –æ–±–ª–∞–∫–µ');
    try{
      // if there's a new map file waiting -> upload it first
      if(lastMapFile){
        const path = `maps/${Date.now()}_${lastMapFile.name.replace(/\s+/g,'_')}`;
        const ref = storage.ref().child(path);
        await ref.put(lastMapFile);
        const url = await ref.getDownloadURL();
        state.map.dataUrl = url;
        state.map.name = lastMapFile.name;
        lastMapFile = null;
      }
      // push full state
      await saveStateCloud();
      toast('–í—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–µ');
    } catch(err){
      console.error(err);
      toast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ –æ–±–ª–∞–∫–æ');
    }
  }

  /* ---------------- helper: force save ---------------- */
  async function forceSave(){
    if(firebaseAvailable() && currentUser && canEditCloud()) await pushLocalToCloud();
    else saveStateLocal();
    toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  }

  /* ---------------- utility ---------------- */
  function editRow(id){ if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü'); openEditPlayer(id); }
  function quickAction(action){ if(action==='giveEnergyAll'){ state.players.forEach(p=>p.energy=Math.min(100,(p.energy||0)+20)); saveStateLocal(); toast('+20 ‚ö° –≤—Å–µ–º (–ª–æ–∫–∞–ª—å–Ω–æ)'); } else if(action==='randomEvent'){ randomEvent(); } }
  function showSignoutButton(visible){ const s=document.getElementById('signoutBtn'); const signin=document.getElementById('signinBtn'); if(visible){ s.classList.remove('hidden'); signin.classList.add('hidden'); } else { s.classList.add('hidden'); signin.classList.remove('hidden'); } }

  /* ---------------- startup ---------------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    // ensure explain blocks exist
    if(!state.explain || Object.keys(state.explain).length===0){
      defaultExplainBlocks.forEach(b => state.explain[b.id] = { id:b.id, title:b.title, summary:b.summary, content:b.content });
      saveStateLocal();
    }
    renderAll();
    // expose for debug
    window._state = state;
    window._saveLocal = saveStateLocal;
    window._pushCloud = pushLocalToCloud;
  });
  </script>
</body>
</html>
