<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ù–æ–≤–∞—è –ó–µ–º–ª—è ‚Äî –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
  <meta name="description" content="–ù–æ–≤–∞—è –ó–µ–º–ª—è ‚Äî –ø—Ä–∞–≤–∏–ª–∞, –∫–∞—Ä—Ç–∞, —Ç–æ–ø—ã –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#071127;
      --card:#0b1220;
      --accent:#6ee7b7;
      --accent2:#60a5fa;
      --muted:#9aa4b2;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0; background:linear-gradient(180deg,var(--bg) 0%, #071827 100%); color:#e6eef6;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#022}
    h1{margin:0;font-size:20px}
    .nav-buttons{display:flex;gap:8px;align-items:center}
    button{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:inherit;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#022;border:none}
    .hero{display:grid;grid-template-columns:1fr 380px;gap:18px;margin-top:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.03)}
    .welcome{padding:22px}
    .muted{color:var(--muted);font-size:14px}
    .map-area img{width:100%;height:auto;border-radius:10px;display:block}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tabs{display:flex;gap:8px;margin-top:12px}
    .tab{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
    .grids{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px}
    table{width:100%;border-collapse:collapse}
    td,th{padding:6px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:14px}
    th{font-weight:600}
    .accordion-item{border-radius:10px;margin-top:8px;overflow:hidden}
    .accordion-head{display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.01);cursor:pointer}
    .accordion-body{padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    footer{margin-top:24px;text-align:center;color:var(--muted);font-size:13px}
    .badge{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.04);font-weight:600}
    .muted-small{color:var(--muted);font-size:13px}
    .small{font-size:13px;color:var(--muted)}
    .editor{border:1px dashed rgba(255,255,255,0.04);padding:8px;border-radius:8px}
    .hidden{display:none !important}
    .uploader{display:flex;gap:6px;align-items:center}
    input[type=file]{display:none}
    .toast{position:fixed;right:20px;bottom:20px;background:#0b1220;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
    .flex{display:flex;gap:8px;align-items:center}
    .admin-only{display:none} /* –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ JS —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º */
    .admin-badge{background:rgba(110,231,183,0.18);color:#0a2b1f;padding:4px 8px;border-radius:999px;font-weight:700}
    .panel{margin-top:12px}
    .input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .row{display:flex;gap:8px;align-items:center}
    .col{display:flex;flex-direction:column;gap:8px}
    .center{text-align:center}
    .danger{background:#7f1d1d;color:white}
    @media(max-width:980px){ .hero{grid-template-columns:1fr} .grids{grid-template-columns:1fr} }
    /* modal */
    .modal-back{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:40}
    .modal{background:#071827;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);min-width:320px;color:inherit}
    .muted-note{color:var(--muted);font-size:13px}
    .stack{display:flex;flex-direction:column;gap:8px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">NZ</div>
        <div>
          <h1>–ù–æ–≤–∞—è –ó–µ–º–ª—è</h1>
          <div class="small muted">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏–≥—Ä—ã ‚Äî –∫–∞—Ä—Ç–∞, –ø—Ä–∞–≤–∏–ª–∞, —Ç–æ–ø—ã –∏ –∞–¥–º–∏–Ω–∫–∞</div>
        </div>
      </div>

      <div class="nav-buttons">
        <div id="roleBadge" class="badge">–ì–æ—Å—Ç—å</div>
        <button onclick="showSection('map')">–ö–∞—Ä—Ç–∞</button>
        <button onclick="showSection('rules')">–ü—Ä–∞–≤–∏–ª–∞</button>
        <button onclick="showSection('tops')">–¢–æ–ø—ã</button>

        <!-- Local login (password) -->
        <button id="localLoginBtn">–í–æ–π—Ç–∏ (–ª–æ–∫–∞–ª—å–Ω–æ)</button>

        <!-- Firebase/Google login (optional) -->
        <button class="primary" id="signinBtn">–í–æ–π—Ç–∏ (Google)</button>
        <button id="signoutBtn" class="hidden">–í—ã–π—Ç–∏</button>
      </div>
    </header>

    <main class="hero">
      <section class="card welcome" id="section-welcome">
        <h2>–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –≤ ¬´–ù–æ–≤–æ–π –ó–µ–º–ª–µ¬ª</h2>
        <p class="muted">–ó–¥–µ—Å—å ‚Äî –∫–∞—Ä—Ç–∞, –ø—Ä–∞–≤–∏–ª–∞ –∏ —Ä–µ–π—Ç–∏–Ω–≥–∏. –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –æ–±–ª–∞–∫–æ (Firebase).</p>

        <div class="controls">
          <button onclick="showSection('map')">–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</button>
          <button onclick="showSection('tops')">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–ø—ã</button>
          <button onclick="showSection('rules')">–ü—Ä–∞–≤–∏–ª–∞ –∏ —Å–∏—Å—Ç–µ–º—ã</button>
          <button onclick="scrollTo('#admin')">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
        </div>

        <div class="tabs">
          <div class="tab" onclick="quickAction('giveEnergyAll')">+20 ‚ö° –≤—Å–µ–º (–¥–µ–º–æ)</div>
          <div class="tab" onclick="quickAction('randomEvent')">–°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ</div>
        </div>

        <div style="margin-top:12px" id="welcomeText" class="small editor" contenteditable="false">
          <strong>–ù–æ–≤–∞—è –ó–µ–º–ª—è</strong> ‚Äî –∏–≥—Ä–∞ –≤ Telegram: –∏–≥—Ä–æ–∫–∏ —Å–æ–∑–¥–∞—é—Ç —Å—Ç—Ä–∞–Ω—ã, —Ç—Ä–∞—Ç—è—Ç —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ —Ä–∞–∑–≤–µ–¥–∫—É –∏ –∑–∞—Ö–≤–∞—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π. –ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—ã —Ö—Ä–∞–Ω–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É, –ø—Ä–∞–≤–∏–ª–∞ –∏ —Ä–µ–π—Ç–∏–Ω–≥–∏.
        </div>

      </section>

      <aside class="card map-area">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>–ö–∞—Ä—Ç–∞ (–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ—é)</strong>
          <div class="small muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è PNG/JPG</div>
        </div>

        <div style="margin-top:10px">
          <label class="uploader">
            <input id="mapFile" type="file" accept="image/*">
            <button onclick="document.getElementById('mapFile').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É</button>
          </label>
          <button onclick="resetMap()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>

        <div style="margin-top:12px">
          <img id="mapPreview" src="" alt="–ö–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞" style="display:none;border-radius:8px;max-height:420px;object-fit:contain;width:100%;">
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="togglePublicEditBtn">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
          <button onclick="exportData()">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
          <label>
            <input type="file" id="importFile" accept="application/json" style="display:none">
            <button onclick="document.getElementById('importFile').click()">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
          </label>
        </div>

        <div class="small muted" style="margin-top:8px">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞—Ä—Ç—É –ª–æ–∫–∞–ª—å–Ω–æ. –í –æ–±–ª–∞—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –∫–∞—Ä—Ç–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ Storage –∏ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º.</div>
      </aside>
    </main>

    <!-- Map section (hidden initially) -->
    <div class="card" id="section-map" style="margin-top:14px;display:none;">
      <h3>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</h3>
      <p class="muted">–ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –∫–∞—Ä—Ç—É, –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –ø–ª–µ–º–µ–Ω–∞ –∏ –∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ã. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤.</p>

      <div id="mapMarkers" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px"></div>
    </div>

    <!-- Tops -->
    <div class="card" id="section-tops" style="margin-top:14px;">
      <h3>–¢–æ–ø—ã –ø–ª–µ–º–µ–Ω</h3>
      <div class="grids">
        <div class="list card">
          <h4>–¢–æ–ø –ø–æ –∞—Ä–º–∏–∏</h4>
          <table id="topArmy"><thead><tr><th>#</th><th>–ü–ª–µ–º—è</th><th>–ê—Ä–º–∏—è</th><th></th></tr></thead><tbody></tbody></table>
        </div>
        <div class="list card">
          <h4>–¢–æ–ø –ø–æ –Ω–∞—Å–µ–ª–µ–Ω–∏—é</h4>
          <table id="topPop"><thead><tr><th>#</th><th>–ü–ª–µ–º—è</th><th>–ù–∞—Å–µ–ª–µ–Ω–∏–µ</th><th></th></tr></thead><tbody></tbody></table>
        </div>
        <div class="list card">
          <h4>–¢–æ–ø –ø–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è–º</h4>
          <table id="topTerr"><thead><tr><th>#</th><th>–ü–ª–µ–º—è</th><th>–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</th><th></th></tr></thead><tbody></tbody></table>
        </div>
        <div class="list card">
          <h4>–¢–æ–ø –ø–æ —É—Ä–æ–≤–Ω—é —Å—á–∞—Å—Ç—å—è</h4>
          <table id="topHappy"><thead><tr><th>#</th><th>–ü–ª–µ–º—è</th><th>–°—á–∞—Å—Ç—å–µ</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <!-- Rules -->
    <div class="card" id="section-rules" style="margin-top:14px;display:none;">
      <h3>–ü—Ä–∞–≤–∏–ª–∞ –∏ —Å–∏—Å—Ç–µ–º—ã</h3>
      <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–∞–≤–∏–ª ‚Äî –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –±—ã–ª–æ –≤ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ -->
      <div class="accordion-item">
        <div class="accordion-head" onclick="toggleAccordion(this)">
          <div>üÜï –î–ª—è –Ω–æ–≤–∏—á–∫–æ–≤</div>
          <div class="small muted">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>
        </div>
        <div class="accordion-body">
          <p><strong>–ï—Å–ª–∏ —Ç—ã –Ω–æ–≤–∏—á–æ–∫, –≤–æ—Ç –∫–∞–∫ –∏–≥—Ä–∞—Ç—å:</strong></p>
          <ol>
            <li>–ü—Ä–∏–¥—É–º–∞–π –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–µ–π —Å—Ç—Ä–∞–Ω—ã</li>
            <li>–°–¥–µ–ª–∞–π —Ñ–ª–∞–≥</li>
            <li>–ù–∞–∑–æ–≤–∏ —Å—Ç–æ–ª–∏—Ü—É</li>
            <li>–í—ã–±–µ—Ä–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</li>
            <li>–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ç–µ–±—è –¥–æ–±–∞–≤—è—Ç –Ω–∞ –∫–∞—Ä—Ç—É</li>
          </ol>
          <p>–ö–∞–∂–¥—ã–π —á–∞—Å +20 ‚ö°Ô∏è, –º–∞–∫—Å–∏–º—É–º 100 ‚ö°Ô∏è. –ù–∞–ª–æ–≥–∏: 5‚Äî40 ‚ö°Ô∏è/—á–∞—Å.</p>
        </div>
      </div>
      <!-- –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Å—é–¥–∞ -->
    </div>

    <!-- Admin panel: —Å–∫—Ä—ã—Ç –¥–ª—è –≥–æ—Å—Ç–µ–π (–ø–æ–∫–∞–∂–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ canEdit()) -->
    <div id="admin" class="card admin-only" style="margin-top:14px;">
      <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å <span id="adminBadge" class="admin-badge">Admin</span></h3>
      <div class="small muted">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Äî –≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.</div>

      <div class="panel" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
        <div class="card">
          <h4>–ë—ã—Å—Ç—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h4>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button onclick="giveEnergyToSelected(20)">+20 ‚ö° –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É</button>
            <button onclick="modifyTax(15)">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ª–æ–≥–∏ +15 ‚ö°</button>
            <button onclick="randomEvent()">–°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ</button>
            <button onclick="addDemoPlayer()">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç-–ø–ª–µ–º—è</button>
            <button onclick="bulkEditPrompt()">–ú–∞—Å—Å–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
          </div>
        </div>

        <div class="card">
          <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∞–π—Ç–∞</h4>
          <div class="col">
            <div>–í–ª–∞–¥–µ–ª–µ—Ü: <span id="ownerInfo" class="small muted">–Ω–µ –∑–∞–¥–∞–Ω</span></div>
            <div class="row">
              <button onclick="setAsOwner()">–°–¥–µ–ª–∞—Ç—å –º–µ–Ω—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º (cloud)</button>
              <button onclick="assignLocalOwner()">–°–¥–µ–ª–∞—Ç—å –º–µ–Ω—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
            </div>
            <div class="row">
              <input id="newAdminEmail" class="input" placeholder="UID –¥–ª—è –∞–¥–º–∏–Ω–∞ (Firebase UID)">
              <button onclick="addAdminByUid()">–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞ (UID)</button>
            </div>
            <div class="row">
              <button onclick="changeLocalPasswords()">–ü–æ–º–µ–Ω—è—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏</button>
              <button onclick="resetToDefault()">–°–±—Ä–æ—Å–∏—Ç—å –≤ –¥–µ—Ñ–æ–ª—Ç</button>
            </div>
            <div class="small muted-note">–°–æ–≤–µ—Ç: –ø–æ–¥–∫–ª—é—á–∏—Ç–µ Firebase –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –Ω–µ –∑–∞—â–∏—â–µ–Ω—ã.</div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <h4>–î–æ–ø. –ê–¥–º–∏–Ω-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h4>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button onclick="exportData()">–≠–∫—Å–ø–æ—Ä—Ç (JSON)</button>
          <button onclick="forceSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ–π—á–∞—Å (cloud/local)</button>
          <button onclick="showLastSaved()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</button>
        </div>
        <div id="lastSaved" class="small muted" style="margin-top:8px"></div>
      </div>
    </div>

    <footer>
      –°–¥–µ–ª–∞–Ω–æ –¥–ª—è –∏–≥—Ä—ã ¬´–ù–æ–≤–∞—è –ó–µ–º–ª—è¬ª. (–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Å–∞–π—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ GitHub Pages + –ø–æ–¥–∫–ª—é—á–∏—Ç–µ Firebase –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è.)  
    </footer>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <!-- Modal for local login -->
  <div id="modalLogin" class="modal-back hidden">
    <div class="modal">
      <h3>–õ–æ–∫–∞–ª—å–Ω—ã–π –≤—Ö–æ–¥ (–ø–∞—Ä–æ–ª—å)</h3>
      <div class="stack">
        <select id="localRoleSelect" class="input">
          <option value="admin">–ê–¥–º–∏–Ω</option>
          <option value="owner">–í–ª–∞–¥–µ–ª–µ—Ü</option>
        </select>
        <input id="localPassword" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å">
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
          <button class="primary" onclick="localLogin()">–í–æ–π—Ç–∏</button>
        </div>
        <div class="muted-note">–õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage –∏ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤. –î–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Firebase Auth.</div>
      </div>
    </div>
  </div>

  <!-- Firebase (compat) ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –ï—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å, –æ—Å—Ç–∞–≤—å FIREBASE_ENABLED=false -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    /**************************************************************************
     * CONFIGURATION
     *
     * FIREBASE_ENABLED = true/false: –≤–∫–ª—é—á–∏—Ç—å –æ–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º (Firestore + Storage + Auth).
     * –ï—Å–ª–∏ –≤–∫–ª—é—á–∞–µ—Ç–µ, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ firebaseConfig –Ω–∏–∂–µ (–≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –∫–æ–Ω—Ñ–∏–≥).
     *
     * –í–ù–ò–ú–ê–ù–ò–ï: –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–µ–ª –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî
     * –≤–∫–ª—é—á–∞–π—Ç–µ Firebase –∏ –≤—Å—Ç–∞–≤–ª—è–π—Ç–µ config. –ë–µ–∑ –æ–±–ª–∞–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
     * —Ç–æ–ª—å–∫–æ –≤ localStorage —Ç–µ–∫—É—â–µ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞.
     **************************************************************************/
    const FIREBASE_ENABLED = false; // —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ true —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å—Ç–∞–≤–∏–ª–∏ firebaseConfig
    const firebaseConfig = {
      // –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à –∫–æ–Ω—Ñ–∏–≥ –æ—Ç Firebase (apiKey, authDomain, projectId, storageBucket, appId ...)
      // –ü—Ä–∏–º–µ—Ä:
      // apiKey: "AIzaSy...",
      // authDomain: "project-id.firebaseapp.com",
      // projectId: "project-id",
      // storageBucket: "project-id.appspot.com",
      // messagingSenderId: "....",
      // appId: "1:...:web:..."
    };

    /******************************* DATA MODEL ********************************/
    const STORAGE_KEY = 'nova_zemlya_data_v2';

    // default ‚Äî publicEdit:false –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —á—Ç–æ–±—ã –≥–æ—Å—Ç–∏ –Ω–µ –º–æ–≥–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
    const defaultData = {
      meta: {
        ownerName: '–í–ª–∞–¥–µ–ª–µ—Ü',
        ownerPass: 'owner123',   // —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –∏–∑–º–µ–Ω–∏—Ç—å
        adminPass: 'admin123',   // —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –∏–∑–º–µ–Ω–∏—Ç—å
        publicEdit: false,       // –µ—Å–ª–∏ true ‚Äî –≥–æ—Å—Ç–∏ —Å–º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ)
        ownerUid: null,          // –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º Firebase, —Å—é–¥–∞ –ø–∏—à–µ–º UID –≤–ª–∞–¥–µ–ª—å—Ü–∞
        admins: []               // –º–∞—Å—Å–∏–≤ UID –∞–¥–º–∏–Ω–æ–≤ (cloud mode)
      },
      map: { dataUrl: '', name: '' },
      players: [
        { id: 1, name: '–ú–ï–¢–ê–ú–§–ò–õ–ï–ù–î', army: 0, pop: 7, territories: 24, happy: 50, energy: 50 },
        { id: 2, name: '–°–Ω—é—Å–õ–µ–Ω–¥', army: 0, pop: 7, territories: 0, happy: 50, energy: 50 }
      ],
      updatedAt: Date.now()
    };

    // runtime state
    let state = loadStateLocal();
    let role = 'guest'; // guest | admin | owner
    let currentUser = null;

    // Firebase handles
    let firebaseApp=null, auth=null, db=null, storage=null, unsubscribeSnapshot=null;

    // Initialize Firebase if enabled
    if (FIREBASE_ENABLED && firebaseConfig && firebaseConfig.apiKey) {
      try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        storage = firebase.storage();
        auth.onAuthStateChanged(async user => {
          currentUser = user;
          if (user) {
            showSignoutButton(true);
            document.getElementById('signinBtn').innerText = '–í–æ–π—Ç–∏ –∫–∞–∫: ' + (user.displayName || user.email);
            // load cloud and subscribe to updates
            await subscribeToCloudState();
          } else {
            showSignoutButton(false);
            document.getElementById('signinBtn').innerText = '–í–æ–π—Ç–∏ (Google)';
            // unsubscribe and fallback to local
            if (unsubscribeSnapshot) { unsubscribeSnapshot(); unsubscribeSnapshot=null; }
            state = loadStateLocal();
            role = 'guest';
            renderAll();
            updateVisibility();
          }
        });
      } catch (e) {
        console.error('Firebase init error', e);
        toast('Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, —Ä–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ');
      }
    } else {
      // Firebase disabled ‚Äî ensure UI shows local mode
      updateVisibility();
    }

    /* ------------------------------- Storage -------------------------------- */
    function loadStateLocal() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData));
        return JSON.parse(JSON.stringify(defaultData));
      }
      try { return JSON.parse(raw); } catch (e) { localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData)); return JSON.parse(JSON.stringify(defaultData)); }
    }
    function saveStateLocal() {
      state.updatedAt = Date.now();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      renderAll();
      updateLastSaved();
    }

    async function subscribeToCloudState(){
      if(!db) return;
      const docRef = db.collection('site').doc('state');
      // create if not exists
      const snap = await docRef.get();
      if(!snap.exists){
        await docRef.set(state);
      }
      // listen for realtime updates
      unsubscribeSnapshot = docRef.onSnapshot(snap => {
        if (!snap.exists) return;
        const cloud = snap.data();
        // simple merge: if cloud newer -> use it
        if(!state.updatedAt || (cloud.updatedAt && cloud.updatedAt > state.updatedAt)){
          state = cloud;
          saveStateLocal(); // keep local copy
          toast('–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞');
        } else {
          // local newer -> push to cloud (but only if we have rights)
          // avoid infinite loop using timestamps
        }
        renderAll();
        updateVisibility();
      });
      // after subscribing, set role based on current user uid and state.meta
      role = 'guest';
      if (currentUser && state.meta) {
        if (state.meta.ownerUid && currentUser.uid === state.meta.ownerUid) role = 'owner';
        else if (Array.isArray(state.meta.admins) && state.meta.admins.includes(currentUser.uid)) role = 'admin';
      }
      updateVisibility();
    }

    async function saveStateCloud(){
      if(!db) return saveStateLocal();
      // check permissions: owner or admin only
      if(!canEditCloud()) { toast('–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –æ–±–ª–∞–∫–æ'); return; }
      const docRef = db.collection('site').doc('state');
      state.updatedAt = Date.now();
      await docRef.set(state);
      saveStateLocal();
      toast('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–µ');
      updateLastSaved();
    }

    function canEditCloud(){
      if(!currentUser || !state.meta) return false;
      if(state.meta.ownerUid && currentUser.uid === state.meta.ownerUid) return true;
      if(Array.isArray(state.meta.admins) && state.meta.admins.includes(currentUser.uid)) return true;
      return false;
    }

    function canEdit(){
      // prefer cloud permission when in cloud mode
      if (FIREBASE_ENABLED && db && currentUser) return canEditCloud();
      // else fallback to local role or publicEdit flag
      if (role === 'owner' || role === 'admin') return true;
      return state.meta && state.meta.publicEdit === true;
    }

    /* ------------------------------- UI / Render ----------------------------- */
    function toast(text, timeout=3000){ const t=document.getElementById('toast'); t.innerText=text; t.style.display='block'; setTimeout(()=>t.style.display='none', timeout); }

    function renderAll(){
      renderMap();
      renderMarkers();
      renderTops();
      updateOwnerInfo();
      updateVisibility();
    }

    function renderMap(){
      const img = document.getElementById('mapPreview');
      if(state.map && state.map.dataUrl){
        img.src = state.map.dataUrl;
        img.style.display = 'block';
      } else {
        img.style.display = 'none';
      }
    }

    function renderMarkers(){
      const wrap = document.getElementById('mapMarkers');
      if(!wrap) return;
      wrap.innerHTML = '';
      const can = canEdit();
      (state.players || []).forEach(p=>{
        const el = document.createElement('div'); el.className = 'card';
        el.innerHTML = `<strong>${escapeHtml(p.name)}</strong>
          <div class="small">–ê—Ä–º–∏—è: ${p.army} ‚Ä¢ –ü–æ–ø: ${p.pop} ‚Ä¢ –¢–µ—Ä—Ä: ${p.territories} ‚Ä¢ –°—á–∞—Å—Ç—å–µ: ${p.happy}%</div>
          <div style="margin-top:8px;display:flex;gap:6px">
            <button onclick="selectPlayer(${p.id})">–í—ã–±—Ä–∞—Ç—å</button>
            ${can ? `<button onclick="openEditPlayer(${p.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>` : ''}
          </div>`;
        wrap.appendChild(el);
      });
    }

    function renderTops(){
      renderTable('topArmy','army');
      renderTable('topPop','pop');
      renderTable('topTerr','territories');
      renderTable('topHappy','happy');
    }

    function renderTable(elId,key){
      const tbody = document.getElementById(elId).querySelector('tbody');
      tbody.innerHTML = '';
      const arr = [...state.players].sort((a,b)=>b[key]-a[key]).slice(0,12);
      const can = canEdit();
      arr.forEach((p,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(p.name)}</td><td>${p[key]}</td><td>${can?'<button onclick="editRow('+p.id+')">‚úèÔ∏è</button>':''}</td>`;
        tbody.appendChild(tr);
      });
    }

    function updateOwnerInfo(){
      const ownerSpan = document.getElementById('ownerInfo');
      if(state.meta && state.meta.ownerName) ownerSpan.innerText = state.meta.ownerName + (state.meta.publicEdit ? ' ‚Ä¢ –ø—É–±–ª–∏—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –í–ö–õ' : ' ‚Ä¢ –ø—É–±–ª–∏—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –í–´–ö–õ');
      else ownerSpan.innerText = '–Ω–µ –∑–∞–¥–∞–Ω';
    }

    function updateVisibility(){
      // admin-only panel
      const adminPanel = document.getElementById('admin');
      if (canEdit()) {
        adminPanel.classList.remove('admin-only');
        adminPanel.style.display = 'block';
      } else {
        adminPanel.classList.add('admin-only');
        adminPanel.style.display = 'none';
      }
      // role badge
      const rb = document.getElementById('roleBadge');
      rb.innerText = role === 'guest' ? '–ì–æ—Å—Ç—å' : (role==='admin' ? '–ê–¥–º–∏–Ω' : '–í–ª–∞–¥–µ–ª–µ—Ü');
      // sign in/out buttons
      showSignoutButton(!!currentUser);
    }

    function escapeHtml(s){
      if(!s) return '';
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    /* ----------------------------- Map Upload -------------------------------- */
    // Setup listener after DOM loaded
    document.addEventListener('DOMContentLoaded', ()=>{
      const mapFile = document.getElementById('mapFile');
      if(mapFile) mapFile.addEventListener('change', onMapFileChange);
      const importFile = document.getElementById('importFile');
      if(importFile) importFile.addEventListener('change', onImportFileChange);
      // bind buttons
      document.getElementById('localLoginBtn').addEventListener('click', ()=>openModal());
      document.getElementById('signinBtn').addEventListener('click', ()=>{ if(firebaseAvailable()) signInWithGoogle(); else toast('Firebase –æ—Ç–∫–ª—é—á—ë–Ω –∏–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'); });
      document.getElementById('signoutBtn').addEventListener('click', ()=>{ if(firebaseAvailable()) auth.signOut(); else localLogout(); });
      renderAll();
    });

    function firebaseAvailable(){ return FIREBASE_ENABLED && typeof firebase !== 'undefined' && auth; }

    async function onMapFileChange(e){
      const f = e.target.files[0]; if(!f) return;
      // quick preview
      const reader = new FileReader();
      reader.onload = ()=>{ state.map.dataUrl = reader.result; state.map.name = f.name; renderMap(); }
      reader.readAsDataURL(f);
      // if cloud and user logged in -> upload to storage and save public URL
      if(firebaseAvailable() && currentUser){
        try{
          const path = `maps/${Date.now()}_${f.name.replace(/\s+/g,'_')}`;
          const ref = storage.ref().child(path);
          await ref.put(f);
          const url = await ref.getDownloadURL();
          state.map.dataUrl = url;
          state.map.name = f.name;
          await saveStateCloud();
        }catch(err){ console.error(err); toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã –≤ –æ–±–ª–∞–∫–æ'); saveStateLocal(); }
      } else {
        saveStateLocal();
      }
      e.target.value = '';
      toast('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    }

    function resetMap(){
      state.map = { dataUrl:'', name:'' };
      if(firebaseAvailable() && currentUser) saveStateCloud(); else saveStateLocal();
      renderMap();
      toast('–ö–∞—Ä—Ç–∞ —Å–±—Ä–æ—à–µ–Ω–∞');
    }

    /* ---------------------------- Players edit ------------------------------- */
    function selectPlayer(id){ const p = state.players.find(x=>x.id===id); if(!p) return toast('–ü–ª–µ–º—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'); window.selectedPlayer = p; toast('–í—ã–±—Ä–∞–Ω: '+p.name); }
    function editRow(id){ if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü'); openEditPlayer(id); }

    async function openEditPlayer(id){
      if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü');
      const p = state.players.find(x=>x.id===id); if(!p) return;
      const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–º–µ–Ω–∏', p.name); if(name!==null) p.name = name;
      const army = parseInt(prompt('–ê—Ä–º–∏—è', p.army)) || p.army;
      const pop = parseInt(prompt('–ù–∞—Å–µ–ª–µ–Ω–∏–µ', p.pop)) || p.pop;
      const terr = parseInt(prompt('–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏', p.territories)) || p.territories;
      const happy = parseInt(prompt('–°—á–∞—Å—Ç—å–µ (0-100)', p.happy)) || p.happy;
      p.army = army; p.pop = pop; p.territories = terr; p.happy = happy;
      if(firebaseAvailable() && currentUser) await saveStateCloud(); else saveStateLocal();
      toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    }

    /* ---------------------------- Admin utilities ---------------------------- */
    function addDemoPlayer(){
      if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü');
      const id = Date.now();
      state.players.push({id, name:'–ù–æ–≤—ã–π_'+id%1000, army:0, pop:5, territories:0, happy:50, energy:50});
      if(firebaseAvailable() && currentUser) saveStateCloud(); else saveStateLocal();
    }

    function bulkEditPrompt(){
      if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü');
      const key = prompt('–ö–∞–∫–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä –º–∞—Å—Å–æ–≤–æ –º–µ–Ω—è—Ç—å? (name/army/pop/territories/happy)');
      if(!key) return;
      const val = prompt('–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–¥–ª—è name ‚Äî —Å—Ç—Ä–æ–∫–∞, –¥–ª—è —á–∏—Å–µ–ª ‚Äî —á–∏—Å–ª–æ)');
      if(val===null) return;
      state.players.forEach(p=>{
        if(key === 'name') p.name = val;
        else p[key] = Number(val) || p[key];
      });
      if(firebaseAvailable() && currentUser) saveStateCloud(); else saveStateLocal();
      toast('–ú–∞—Å—Å–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
    }

    function modifyTax(n){
      if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü');
      state.players.forEach(p => { p.happy = Math.max(0, p.happy - Math.round(n/2)); });
      if(firebaseAvailable() && currentUser) saveStateCloud(); else saveStateLocal();
      toast('–ù–∞–ª–æ–≥–∏ –∏–∑–º–µ–Ω–µ–Ω—ã ‚Äî —Å—á–∞—Å—Ç—å–µ —É–ø–∞–ª–æ');
    }

    function giveEnergyToSelected(n){
      if(!window.selectedPlayer) return toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–ª–µ–º—è');
      window.selectedPlayer.energy = Math.min(100, (window.selectedPlayer.energy||0) + n);
      if(firebaseAvailable() && currentUser) saveStateCloud(); else saveStateLocal();
    }

    function randomEvent(){
      if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü');
      const ev = Math.random();
      if(ev < 0.33) state.players.forEach(p=>p.happy = Math.max(0,p.happy-5));
      else if(ev < 0.66) state.players.forEach(p=>p.pop = Math.max(1,p.pop-1));
      else state.players.forEach(p=>p.army += 5);
      if(firebaseAvailable() && currentUser) saveStateCloud(); else saveStateLocal();
      toast('–°–æ–±—ã—Ç–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ');
    }

    function resetToDefault(){
      if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –¥–µ—Ñ–æ–ª—Ç? –≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ.')) return;
      state = JSON.parse(JSON.stringify(defaultData));
      if(firebaseAvailable() && currentUser) saveStateCloud(); else saveStateLocal();
      toast('–°–±—Ä–æ—à–µ–Ω–æ –≤ –¥–µ—Ñ–æ–ª—Ç');
    }

    /* ------------------------- Export / Import ------------------------------- */
    function exportData(){
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'nova_zemlya_data.json'; a.click();
      URL.revokeObjectURL(url);
    }

    function onImportFileChange(e){
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = async ()=> {
        try {
          const obj = JSON.parse(r.result);
          if(obj && obj.players){
            if(!confirm('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –∏ –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ?')) return;
            state = obj;
            if(firebaseAvailable() && currentUser) await saveStateCloud(); else saveStateLocal();
            toast('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
          } else toast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–∞–π–ª');
        } catch(err) { toast('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞'); }
      };
      r.readAsText(f);
      e.target.value = '';
    }

    /* ------------------------ Local auth & modal ----------------------------- */
    function openModal(){ document.getElementById('modalLogin').classList.remove('hidden'); }
    function closeModal(){ document.getElementById('modalLogin').classList.add('hidden'); }
    function localLogin(){
      const roleSel = document.getElementById('localRoleSelect').value;
      const pass = document.getElementById('localPassword').value;
      if(!pass){ toast('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'); return; }
      const meta = state.meta || {};
      if(roleSel === 'owner' && pass === meta.ownerPass){
        role = 'owner';
        closeModal();
        toast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω –∫–∞–∫ –í–ª–∞–¥–µ–ª–µ—Ü (–ª–æ–∫–∞–ª—å–Ω–æ)');
        updateVisibility();
        return;
      }
      if(roleSel === 'admin' && pass === meta.adminPass){
        role = 'admin';
        closeModal();
        toast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω –∫–∞–∫ –ê–¥–º–∏–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)');
        updateVisibility();
        return;
      }
      toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å');
    }

    function assignLocalOwner(){
      if(!confirm('–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –ª–æ–∫–∞–ª—å–Ω–æ (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage)?')) return;
      // –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞–∑–Ω–∞—á–∞–µ–º ownerName –ø–æ prompt
      const name = prompt('–ò–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –≤ UI)', state.meta.ownerName || '–í–ª–∞–¥–µ–ª–µ—Ü');
      if(!name) return;
      state.meta.ownerName = name;
      state.meta.ownerPass = prompt('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞', state.meta.ownerPass || '');
      saveStateLocal();
      toast('–õ–æ–∫–∞–ª—å–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü –Ω–∞–∑–Ω–∞—á–µ–Ω');
    }

    function changeLocalPasswords(){
      if(!canEdit()) return toast('–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü/–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –ø–∞—Ä–æ–ª–∏');
      const op = prompt('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)', '');
      if(op) state.meta.ownerPass = op;
      const ap = prompt('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)', '');
      if(ap) state.meta.adminPass = ap;
      saveStateLocal();
      toast('–õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
    }

    /* ------------------------- Firebase helpers ----------------------------- */
    async function signInWithGoogle(){
      if(!firebaseAvailable()) return toast('Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
      const provider = new firebase.auth.GoogleAuthProvider();
      try { await auth.signInWithPopup(provider); } catch(err){ console.error(err); toast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google'); }
    }
    function localLogout(){ role='guest'; currentUser=null; updateVisibility(); toast('–í—ã—à–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ'); }
    function showSignoutButton(visible){
      const s = document.getElementById('signoutBtn');
      const signin = document.getElementById('signinBtn');
      if(visible){ s.classList.remove('hidden'); signin.classList.add('hidden'); } else { s.classList.add('hidden'); signin.classList.remove('hidden'); }
    }

    async function setAsOwner(){
      if(!firebaseAvailable() || !currentUser) return toast('–î–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤ –æ–±–ª–∞–∫–æ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google –∏ –≤–∫–ª—é—á–∏—Ç–µ Firebase');
      state.meta.ownerUid = currentUser.uid;
      state.meta.ownerName = currentUser.displayName || currentUser.email;
      await saveStateCloud();
      toast('–í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –≤ –æ–±–ª–∞–∫–µ');
    }

    function addAdminByUid(){
      const uid = document.getElementById('newAdminEmail').value.trim();
      if(!uid) return toast('–í–≤–µ–¥–∏—Ç–µ UID');
      state.meta.admins = state.meta.admins || [];
      if(!state.meta.admins.includes(uid)) state.meta.admins.push(uid);
      if(firebaseAvailable() && currentUser) saveStateCloud(); else saveStateLocal();
      toast('UID –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ –∞–¥–º–∏–Ω (–µ—Å–ª–∏ cloud ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)');
    }

    /* --------------------------- Utility funcs ------------------------------ */
    function showLastSaved(){
      const ls = state.updatedAt ? new Date(state.updatedAt).toLocaleString() : '–Ω–∏–∫–æ–≥–¥–∞';
      document.getElementById('lastSaved').innerText = '–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: ' + ls;
      toast('–ü–æ–∫–∞–∑–∞–Ω–æ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    }
    function updateLastSaved(){
      if(state.updatedAt) document.getElementById('lastSaved').innerText = '–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: ' + new Date(state.updatedAt).toLocaleString();
    }

    async function forceSave(){
      if(firebaseAvailable() && currentUser) await saveStateCloud(); else saveStateLocal();
      toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    }

    /* ---------------------------- Navigation -------------------------------- */
    function showSection(name){
      document.getElementById('section-map').style.display = (name==='map') ? 'block' : 'none';
      document.getElementById('section-rules').style.display = (name==='rules') ? 'block' : 'none';
      document.getElementById('section-tops').style.display = (name==='tops') ? 'block' : 'none';
      if(name === 'map') renderMap();
    }
    function scrollTo(sel){ const el = document.querySelector(sel); if(el) el.scrollIntoView({behavior:'smooth'}); }

    function toggleAccordion(head){ const body = head.nextElementSibling; if(body.style.display === 'block') body.style.display = 'none'; else body.style.display = 'block'; }

    /* -------------------- startup render and expose for debug ---------------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      renderAll();
      updateLastSaved();
      // Expose for debugging
      window._state = state;
      window._saveLocal = saveStateLocal;
      window._saveCloud = saveStateCloud;
      window._canEdit = canEdit;
    });
  </script>
  
  <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const FIREBASE_ENABLED = true;

const firebaseConfig = {
  apiKey: "AIzaSyCscnMBP6XVMdFRo7TPbn6qmQRtJ045f9I",
  authDomain: "new-earth-cd366.firebaseapp.com",
  projectId: "new-earth-cd366",
  storageBucket: "new-earth-cd366.firebasestorage.app",
  messagingSenderId: "346630323608",
  appId: "1:346630323608:web:135d4fd9118404f62e3fed",
  measurementId: "G-N6BN0H0R9L"
};

  firebase.initializeApp(firebaseConfig);

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã Firebase
  window.firebaseAuth = firebase.auth();
  window.firebaseDB = firebase.firestore();
</script>

</body>
</html>




