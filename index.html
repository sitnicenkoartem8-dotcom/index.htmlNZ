<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ù–æ–≤–∞—è –ó–µ–º–ª—è ‚Äî –æ—Ñ—Ñ–ª–∞–π–Ω / –æ–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º</title>
  <meta name="description" content="–°–∞–π—Ç-—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –¥–ª—è –∏–≥—Ä—ã –ù–æ–≤–∞—è –ó–µ–º–ª—è ‚Äî –ø—Ä–∞–≤–∏–ª–∞, –∫–∞—Ä—Ç–∞, —Ç–æ–ø—ã –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#6ee7b7;--muted:#9aa4b2;--glass: rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial; margin:0;background:linear-gradient(180deg,#071127 0%, #071827 100%);color:#e6eef6}
    .container{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:54px;height:54px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:800;color:#022}
    h1{margin:0;font-size:20px}
    .nav-buttons{display:flex;gap:8px;align-items:center}
    button{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:inherit;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#60a5fa);color:#022;border:none}
    .hero{display:grid;grid-template-columns:1fr 380px;gap:18px;margin-top:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.03)}
    .welcome{padding:22px}
    .welcome h2{margin:0 0 8px 0}
    .muted{color:var(--muted);font-size:14px}
    .map-area img{width:100%;height:auto;border-radius:10px;display:block}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tabs{display:flex;gap:8px;margin-top:12px}
    .tab{padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
    .grids{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px}
    .list{padding:12px}
    table{width:100%;border-collapse:collapse}
    td,th{padding:6px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:14px}
    th{font-weight:600}
    .accordion-item{border-radius:10px;margin-top:8px;overflow:hidden}
    .accordion-head{display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.01);cursor:pointer}
    .accordion-body{padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    footer{margin-top:24px;text-align:center;color:var(--muted);font-size:13px}
    .badge{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.04);font-weight:600}
    @media(max-width:900px){.hero{grid-template-columns:1fr} .grids{grid-template-columns:1fr}}
    .flex{display:flex;gap:8px;align-items:center}
    input[type=file]{display:none}
    .uploader{display:flex;gap:6px;align-items:center}
    .toast{position:fixed;right:20px;bottom:20px;background:#0b1220;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
    .small{font-size:13px;color:var(--muted)}
    .editor{border:1px dashed rgba(255,255,255,0.04);padding:8px;border-radius:8px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">NZ</div>
        <div>
          <h1>–ù–æ–≤–∞—è –ó–µ–º–ª—è</h1>
          <div class="small muted">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏–≥—Ä—ã ‚Äî –∫–∞—Ä—Ç–∞, –ø—Ä–∞–≤–∏–ª–∞, —Ç–æ–ø—ã –∏ –∞–¥–º–∏–Ω–∫–∞</div>
        </div>
      </div>
      <div class="nav-buttons">
        <div id="roleBadge" class="badge">–ì–æ—Å—Ç—å</div>
        <button onclick="showSection('map')">–ö–∞—Ä—Ç–∞</button>
        <button onclick="showSection('rules')">–ü—Ä–∞–≤–∏–ª–∞</button>
        <button onclick="showSection('tops')">–¢–æ–ø—ã</button>
        <button class="primary" id="signinBtn">–í–æ–π—Ç–∏ (Google)</button>
        <button onclick="signOut()">–í—ã–π—Ç–∏</button>
      </div>
    </header>

    <main class="hero">
      <section class="card welcome" id="section-welcome">
        <h2>–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é –≤ ¬´–ù–æ–≤–æ–π –ó–µ–º–ª–µ¬ª</h2>
        <p class="muted">–ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥—ë—Ç–µ –∫–∞—Ä—Ç—É, –ø—Ä–∞–≤–∏–ª–∞ –∏ —Ç–µ–∫—É—â–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∏ –ø–ª–µ–º—ë–Ω. –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Ö–æ–¥ –∫–∞–∫ –í–ª–∞–¥–µ–ª–µ—Ü –∏–ª–∏ –ê–¥–º–∏–Ω.</p>

        <div class="controls">
          <button onclick="showSection('map')">–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</button>
          <button onclick="showSection('tops')">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–ø—ã</button>
          <button onclick="showSection('rules')">–ü—Ä–∞–≤–∏–ª–∞ –∏ —Å–∏—Å—Ç–µ–º—ã</button>
          <button onclick="scrollTo('#admin')">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
        </div>

        <div class="tabs">
          <div class="tab" onclick="quickAction('giveEnergyAll')">+20 ‚ö° –≤—Å–µ–º (–¥–µ–º–æ)</div>
          <div class="tab" onclick="quickAction('randomEvent')">–°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ</div>
        </div>

        <div style="margin-top:12px" id="welcomeText" class="small editor" contenteditable="false">
          <strong>–ù–æ–≤–∞—è –ó–µ–º–ª—è</strong> ‚Äî –∏–≥—Ä–∞ –≤ Telegram: –∏–≥—Ä–æ–∫–∏ —Å–æ–∑–¥–∞—é—Ç —Å—Ç—Ä–∞–Ω—ã, —Ç—Ä–∞—Ç—è—Ç —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ —Ä–∞–∑–≤–µ–¥–∫—É –∏ –∑–∞—Ö–≤–∞—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π. –ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—ã –º–æ–∂–µ—Ç–µ —Ö—Ä–∞–Ω–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É, –ø—Ä–∞–≤–∏–ª–∞ –∏ —Ä–µ–π—Ç–∏–Ω–≥–∏.
        </div>

      </section>

      <aside class="card map-area">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>–ö–∞—Ä—Ç–∞ (–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ—é)</strong>
          <div class="small muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è PNG/JPG</div>
        </div>

        <div style="margin-top:10px">
          <label class="uploader">
            <input id="mapFile" type="file" accept="image/*">
            <button onclick="document.getElementById('mapFile').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É</button>
          </label>
          <button onclick="resetMap()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>

        <div style="margin-top:12px">
          <img id="mapPreview" src="" alt="–ö–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞" style="display:none">
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button onclick="togglePublicEdit()">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
          <button onclick="exportData()">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
          <label style="display:inline-block">
            <input type="file" id="importFile" accept="application/json" style="display:none">
            <button onclick="document.getElementById('importFile').click()">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
          </label>
        </div>

      </aside>
    </main>

    <div class="card" style="margin-top:14px" id="section-map" hidden>
      <h3>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</h3>
      <p class="muted">–ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –∫–∞—Ä—Ç—É, –æ—Ç–º–µ—á–∞–π—Ç–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ (–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤).</p>
      <div id="mapMarkers" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-top:12px"></div>
      <div class="small muted" style="margin-top:10px">–§—É–Ω–∫—Ü–∏–∏: –∫–ª–∏–∫ –ø–æ –ø–ª–µ–º–µ–Ω–∏ ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –∞–¥–º–∏–Ω/–≤–ª–∞–¥–µ–ª–µ—Ü).</div>
    </div>

    <div class="card" style="margin-top:14px" id="section-tops">
      <h3>–¢–æ–ø—ã –ø–ª–µ–º–µ–Ω</h3>
      <div class="grids">
        <div class="list card">
          <h4>–¢–æ–ø –ø–æ –∞—Ä–º–∏–∏</h4>
          <table id="topArmy"><thead><tr><th>#</th><th>–ü–ª–µ–º—è</th><th>–ê—Ä–º–∏—è</th><th></th></tr></thead><tbody></tbody></table>
        </div>
        <div class="list card">
          <h4>–¢–æ–ø –ø–æ –Ω–∞—Å–µ–ª–µ–Ω–∏—é</h4>
          <table id="topPop"><thead><tr><th>#</th><th>–ü–ª–µ–º—è</th><th>–ù–∞—Å–µ–ª–µ–Ω–∏–µ</th><th></th></tr></thead><tbody></tbody></table>
        </div>
        <div class="list card">
          <h4>–¢–æ–ø –ø–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è–º</h4>
          <table id="topTerr"><thead><tr><th>#</th><th>–ü–ª–µ–º—è</th><th>–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</th><th></th></tr></thead><tbody></tbody></table>
        </div>
        <div class="list card">
          <h4>–¢–æ–ø –ø–æ —É—Ä–æ–≤–Ω—é —Å—á–∞—Å—Ç—å—è</h4>
          <table id="topHappy"><thead><tr><th>#</th><th>–ü–ª–µ–º—è</th><th>–°—á–∞—Å—Ç—å–µ</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px" id="section-rules" hidden>
      <h3>–ü—Ä–∞–≤–∏–ª–∞ –∏ —Å–∏—Å—Ç–µ–º—ã</h3>
      <!-- ... (–≤—Å—ë –∫–∞–∫ —Ä–∞–Ω—å—à–µ, –æ–ø—É—â–µ–Ω–æ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏) ... -->
      <div class="accordion-item">
        <div class="accordion-head" onclick="toggleAccordion(this)">
          <div>üÜï –î–ª—è –Ω–æ–≤–∏—á–∫–æ–≤</div>
          <div class="small muted">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å</div>
        </div>
        <div class="accordion-body">
          <p><strong>–ï—Å–ª–∏ —Ç—ã –Ω–æ–≤–∏—á–æ–∫, –≤–æ—Ç –∫–∞–∫ –∏–≥—Ä–∞—Ç—å:</strong></p>
          <ol>
            <li>–ü—Ä–∏–¥—É–º–∞–π –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–µ–π —Å—Ç—Ä–∞–Ω—ã</li>
            <li>–°–¥–µ–ª–∞–π —Ñ–ª–∞–≥</li>
            <li>–ù–∞–∑–æ–≤–∏ —Å—Ç–æ–ª–∏—Ü—É</li>
            <li>–í—ã–±–µ—Ä–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</li>
            <li>–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ç–µ–±—è –¥–æ–±–∞–≤—è—Ç –Ω–∞ –∫–∞—Ä—Ç—É</li>
          </ol>
          <p>–ö–∞–∂–¥—ã–π —á–∞—Å +20 ‚ö°Ô∏è, –º–∞–∫—Å–∏–º—É–º 100 ‚ö°Ô∏è. –ù–∞–ª–æ–≥–∏: 5‚Äî40 ‚ö°Ô∏è/—á–∞—Å. –°–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–µ ‚Äî —Ä–∏—Å–∫ –≤–æ—Å—Å—Ç–∞–Ω–∏—è.</p>
        </div>
      </div>
      <!-- –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Ç–∞–∫–æ–µ –∂–µ, –∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ -->
    </div>

    <div id="admin" class="card" style="margin-top:14px">
      <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
      <div class="small muted">–ó–¥–µ—Å—å ‚Äî –±—ã—Å—Ç—Ä—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã. –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –í–ª–∞–¥–µ–ª–µ—Ü/–ê–¥–º–∏–Ω –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.</div>

      <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="card">
          <h4>–ë—ã—Å—Ç—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h4>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button onclick="giveEnergyToSelected(20)">+20 ‚ö° –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É</button>
            <button onclick="modifyTax(15)">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ª–æ–≥–∏ +15 ‚ö°</button>
            <button onclick="randomEvent()">–°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ</button>
            <button onclick="addDemoPlayer()">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç-–ø–ª–µ–º—è</button>
          </div>
        </div>

        <div class="card">
          <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∞–π—Ç–∞</h4>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div>–í–ª–∞–¥–µ–ª–µ—Ü: <span id="ownerInfo" class="small muted">–Ω–µ –∑–∞–¥–∞–Ω</span></div>
            <button onclick="setAsOwner()">–°–¥–µ–ª–∞—Ç—å –º–æ–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º (–í–ª–∞–¥–µ–ª–µ—Ü)</button>
            <button onclick="changePassword('owner')">–°–º–µ–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)</button>
            <div class="small muted">–°–æ–≤–µ—Ç: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Firebase –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Ä–æ–ª–µ–π –∏ –æ–±—â–µ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è.</div>
          </div>
        </div>
      </div>

    </div>

    <footer>
      –°–¥–µ–ª–∞–Ω–æ –¥–ª—è –∏–≥—Ä—ã ¬´–ù–æ–≤–∞—è –ó–µ–º–ª—è¬ª. –†–µ–∫–æ–º–µ–Ω–¥—É—é —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Å–∞–π—Ç –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–º —Ö–æ—Å—Ç–∏–Ω–≥–µ –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å Firebase –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã.  
    </footer>

  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <!-- Firebase (compat) ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ; –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ‚Äî –æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // ---------- –ù–∞—Å—Ç—Ä–æ–π–∫–∞: –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Firebase, –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é ----------
    // –ß—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Ä–∞–±–æ—Ç–∞—é—â–µ–µ –ª–æ–∫–∞–ª—å–Ω–æ, Firebase –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã –¥–æ–±–∞–≤–∏—Ç–µ config.
    const FIREBASE_ENABLED = true; // –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å: true —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–ª–∞–∫–æ (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤ false, –µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–ª–∏)
    const firebaseConfig = {
      /* FIREBASE CONFIG ‚Äî –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–ò –î–ê–ù–ù–´–ï:
      apiKey: "...",
      authDomain: "...",
      projectId: "...",
      storageBucket: "...",
      messagingSenderId: "...",
      appId: "..."
      */
    };

    // ---------- –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (fallback) ----------
    const STORAGE_KEY = 'nova_zemlya_data_v1'
    const defaultData = {
      meta:{ ownerName:'–í–ª–∞–¥–µ–ª–µ—Ü', ownerPass:'owner123', adminPass:'admin123', publicEdit:true, ownerUid:null, admins:[] },
      map:{ dataUrl:'', name:'' },
      players: [
        {id:1,name:'–ú–ï–¢–ê–ú–§–ò–õ–ï–ù–î',army:0,pop:7,territories:24,happy:50,energy:50},
        {id:2,name:'–°–Ω—é—Å–õ–µ–Ω–¥',army:0,pop:7,territories:0,happy:50,energy:50}
      ],
      updatedAt: Date.now()
    }

    // ---------- State and role ----------
    let state = loadStateLocal()
    let role = 'guest' // guest | admin | owner | user
    let currentUser = null // firebase user

    // ---------- Firebase variables ----------
    let firebaseApp=null, auth=null, db=null, storage=null

    // Initialize Firebase if config present
    if(FIREBASE_ENABLED && firebaseConfig && firebaseConfig.apiKey){
      try{
        firebaseApp = firebase.initializeApp(firebaseConfig)
        auth = firebase.auth()
        db = firebase.firestore()
        storage = firebase.storage()
        // auth state change
        auth.onAuthStateChanged(async user=>{
          currentUser = user
          if(user){ document.getElementById('signinBtn').innerText = '–í–æ–π—Ç–∏ –∫–∞–∫: ' + (user.displayName || user.email)
            await loadStateCloud() // –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –æ–±–ª–∞–∫–∞
          } else {
            document.getElementById('signinBtn').innerText = '–í–æ–π—Ç–∏ (Google)'
            // keep local state if not logged in
            state = loadStateLocal()
            updateUI()
          }
        })
      }catch(e){ console.warn('Firebase init error', e); toast('Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ') }
    }

    // ---------- Local storage helpers ----------
    function loadStateLocal(){
      const raw = localStorage.getItem(STORAGE_KEY)
      if(!raw){ localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData)); return JSON.parse(JSON.stringify(defaultData)) }
      try{ return JSON.parse(raw) }catch(e){ localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData)); return JSON.parse(JSON.stringify(defaultData)) }
    }
    function saveStateLocal(){
      state.updatedAt = Date.now()
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state))
      renderAll()
    }

    // ---------- Cloud functions ----------
    async function loadStateCloud(){
      if(!db) return
      const docRef = db.collection('site').doc('state')
      const snap = await docRef.get()
      if(!snap.exists){
        // –∑–∞–ø–∏—Å–∞—Ç—å initial state –≤ –æ–±–ª–∞–∫–æ (–µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ)
        await docRef.set(state)
        toast('–°–æ–∑–¥–∞–Ω –Ω–∞—á–∞–ª—å–Ω—ã–π state –≤ –æ–±–ª–∞–∫–µ')
      } else {
        // –µ—Å–ª–∏ –æ–±–ª–∞—á–Ω—ã–π state –Ω–æ–≤–µ–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        const cloud = snap.data()
        // –ø—Ä–æ—Å—Ç–æ–π —Å–ª–∏—è—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º: –≤—ã–±–∏—Ä–∞–µ–º –±–æ–ª–µ–µ —Å–≤–µ–∂–∏–π
        if(!state.updatedAt || (cloud.updatedAt && cloud.updatedAt > state.updatedAt)){
          state = cloud
          saveStateLocal()
          toast('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞')
        } else {
          // –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–µ–µ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö –≤ –æ–±–ª–∞–∫–æ
          await docRef.set(state)
          toast('–û–±–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö')
        }
      }
      updateUI()
    }

    async function saveStateCloud(){
      if(!db) return saveStateLocal()
      // –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω/–≤–ª–∞–¥–µ–ª–µ—Ü –ø–∏—à–µ—Ç
      if(!canEditCloud()) { toast('–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –æ–±–ª–∞–∫–æ'); return }
      const docRef = db.collection('site').doc('state')
      state.updatedAt = Date.now()
      await docRef.set(state)
      saveStateLocal() // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ —Ç–æ–∂–µ
      toast('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –æ–±–ª–∞–∫–µ')
    }

    // Simple cloud permission check (based on meta.ownerUid / meta.admins)
    function canEditCloud(){
      if(!currentUser) return false
      if(!state.meta) return false
      if(state.meta.ownerUid && currentUser.uid === state.meta.ownerUid) return true
      if(Array.isArray(state.meta.admins) && state.meta.admins.includes(currentUser.uid)) return true
      return false
    }

    // ---------- UI helpers ----------
    function toast(text, timeout=3000){ const t=document.getElementById('toast'); t.innerText=text; t.style.display='block'; setTimeout(()=>t.style.display='none', timeout) }
    function renderAll(){ renderMap(); renderTops(); renderMarkers(); updateOwnerInfo(); }
    function renderMap(){ const img=document.getElementById('mapPreview'); if(state.map && state.map.dataUrl){ img.src = state.map.dataUrl; img.style.display='block' } else img.style.display='none' }
    function renderMarkers(){ const wrap=document.getElementById('mapMarkers'); if(!wrap) return; wrap.innerHTML=''; (state.players||[]).forEach(p=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML = `<strong>${p.name}</strong><div class="small">–ê—Ä–º–∏—è: ${p.army} ‚Ä¢ –ü–æ–ø: ${p.pop} ‚Ä¢ –¢–µ—Ä—Ä: ${p.territories} ‚Ä¢ –°—á–∞—Å—Ç—å–µ: ${p.happy}%</div><div style="margin-top:8px;display:flex;gap:6px"><button onclick="selectPlayer(${p.id})">–í—ã–±—Ä–∞—Ç—å</button><button onclick="openEditPlayer(${p.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button></div>`; wrap.appendChild(el); }) }
    function renderTops(){ renderTable('topArmy','army'); renderTable('topPop','pop'); renderTable('topTerr','territories'); renderTable('topHappy','happy') }
    function renderTable(elId,key){ const tbody=document.getElementById(elId).querySelector('tbody'); tbody.innerHTML=''; const arr=[...state.players].sort((a,b)=>b[key]-a[key]).slice(0,12); arr.forEach((p,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${p.name}</td><td>${p[key]}</td><td><button onclick="editRow(${p.id})">‚úèÔ∏è</button></td>`; tbody.appendChild(tr); }) }

    // ---------- File upload (image) ----------
    document.getElementById('mapFile').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return
      // client preview quickly
      const reader = new FileReader(); reader.onload = ()=>{ state.map.dataUrl = reader.result; state.map.name = f.name; renderMap() }
      reader.readAsDataURL(f)
      // if firebase enabled -> upload to storage and store URL
      if(storage && currentUser){
        const path = `maps/${Date.now()}_${f.name.replace(/\s/g,'_')}`
        const ref = storage.ref().child(path)
        await ref.put(f)
        const url = await ref.getDownloadURL()
        state.map.dataUrl = url
        state.map.name = f.name
        // save to cloud/local
        await saveStateCloud()
      } else {
        // save local only
        saveStateLocal()
      }
      toast('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞')
      // reset input
      e.target.value = ''
    })

    function resetMap(){ state.map = {dataUrl:'',name:''}; if(storage && currentUser) saveStateCloud(); else saveStateLocal(); renderMap(); }

    // ---------- Players editing ----------
    function selectPlayer(id){ const p = state.players.find(x=>x.id===id); if(!p) return toast('–ü–ª–µ–º—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'); window.selectedPlayer = p; toast('–í—ã–±—Ä–∞–Ω: '+p.name) }
    async function openEditPlayer(id){ if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü'); const p = state.players.find(x=>x.id===id); if(!p) return
      const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–º–µ–Ω–∏', p.name); if(name!==null) p.name = name
      const army = parseInt(prompt('–ê—Ä–º–∏—è', p.army)) || p.army
      const pop = parseInt(prompt('–ù–∞—Å–µ–ª–µ–Ω–∏–µ', p.pop)) || p.pop
      const terr = parseInt(prompt('–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏', p.territories)) || p.territories
      const happy = parseInt(prompt('–°—á–∞—Å—Ç—å–µ (0-100)', p.happy)) || p.happy
      p.army = army; p.pop = pop; p.territories = terr; p.happy = happy
      // save to cloud/local
      if(storage && currentUser) await saveStateCloud(); else saveStateLocal()
      toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')
    }

    function editRow(id){ if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü'); openEditPlayer(id) }

    // ---------- Roles / Auth ----------
    // Local canEdit: local publicEdit flag or role variable
    function canEdit(){ // if cloud enabled, prefer cloud permissions
      if(storage && currentUser) return canEditCloud()
      // fallback to local rules (publicEdit or local owner/admin)
      if(role==='owner' || role==='admin') return true
      return state.meta && state.meta.publicEdit
    }

    // Sign in with Google (Firebase)
    async function signIn(){
      if(!auth){ toast('Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –í–∫–ª—é—á–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–ª–∞—á–Ω—ã–π —Ä–µ–∂–∏–º.'); return }
      const provider = new firebase.auth.GoogleAuthProvider()
      try{ await auth.signInWithPopup(provider) }catch(e){ console.error(e); toast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞') }
    }
    async function signOut(){ if(auth) await auth.signOut(); role='guest'; currentUser=null; updateUI(); toast('–í—ã—à–ª–∏') }

    // Button binding
    document.getElementById('signinBtn').addEventListener('click', ()=>{ if(currentUser) toast('–£–∂–µ –≤ —Å–∏—Å—Ç–µ–º–µ'); else signIn() })

    // Set current user as owner (only available if logged in)
    async function setAsOwner(){
      if(!currentUser || !db) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ –≤ Firebase')
      state.meta.ownerUid = currentUser.uid
      state.meta.ownerName = currentUser.displayName || currentUser.email
      await saveStateCloud()
      toast('–í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –≤–ª–∞–¥–µ–ª—å—Ü–µ–º (–æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ –æ–±–ª–∞–∫–µ)')
    }

    function changePassword(kind){ // –ª–æ–∫–∞–ª—å–Ω–∞—è —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è (–≤ —Ä–µ–∂–∏–º–µ localStorage —Ç–æ–ª—å–∫–æ)
      if(!canEdit()) return toast('–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü/–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å')
      if(kind==='owner'){ const np=prompt('–ù–æ–≤—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–∞'); if(np) state.meta.ownerPass=np }
      else { const np=prompt('–ù–æ–≤—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞'); if(np) state.meta.adminPass=np }
      if(storage && currentUser) saveStateCloud(); else saveStateLocal()
      toast('–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω')
    }

    function updateUI(){
      document.getElementById('roleBadge').innerText = role==='guest' ? '–ì–æ—Å—Ç—å' : (role==='admin' ? '–ê–¥–º–∏–Ω' : '–í–ª–∞–¥–µ–ª–µ—Ü')
      renderAll()
      // ownerInfo
      const ownerSpan = document.getElementById('ownerInfo')
      if(state.meta && state.meta.ownerName) ownerSpan.innerText = state.meta.ownerName + (state.meta.publicEdit ? ' ‚Ä¢ –ø—É–±–ª–∏—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –í–ö–õ' : ' ‚Ä¢ –ø—É–±–ª–∏—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –í–´–ö–õ')
      else ownerSpan.innerText = '–Ω–µ –∑–∞–¥–∞–Ω'
    }

    function togglePublicEdit(){ if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –í–ª–∞–¥–µ–ª–µ—Ü/–ê–¥–º–∏–Ω'); state.meta.publicEdit = !state.meta.publicEdit; if(storage && currentUser) saveStateCloud(); else saveStateLocal(); toast('–ü—É–±–ª–∏—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: '+(state.meta.publicEdit ? '–í–ö–õ' : '–í–´–ö–õ')) }

    // ---------- Actions / Quick functions ----------
    function giveEnergyToSelected(n){ if(!window.selectedPlayer) return toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–ª–µ–º—è'); window.selectedPlayer.energy = Math.min(100, (window.selectedPlayer.energy||0)+n); if(storage && currentUser) saveStateCloud(); else saveStateLocal(); }
    function modifyTax(n){ state.players.forEach(p=>{ p.happy = Math.max(0, p.happy - Math.round(n/2)) }); if(storage && currentUser) saveStateCloud(); else saveStateLocal(); toast('–ù–∞–ª–æ–≥–∏ –∏–∑–º–µ–Ω–µ–Ω—ã ‚Äî —Å—á–∞—Å—Ç—å–µ —É–ø–∞–ª–æ') }
    function quickAction(action){ if(action==='giveEnergyAll'){ state.players.forEach(p=>p.energy = Math.min(100,(p.energy||0)+20)); if(storage && currentUser) saveStateCloud(); else saveStateLocal(); toast('+20 —ç–Ω–µ—Ä–≥–∏–∏ –≤—Å–µ–º –ø–ª–µ–º–µ–Ω–∞–º') } if(action==='randomEvent') randomEvent() }
    function randomEvent(){ const ev=Math.random(); if(ev<0.33){ state.players.forEach(p=>p.happy = Math.max(0,p.happy-5)); toast('–ü—Ä–æ–∏–∑–æ—à–ª–∏ –ø–æ–∂–∞—Ä—ã ‚Äî —Å—á–∞—Å—Ç—å–µ —É–ø–∞–ª–æ') } else if(ev<0.66){ state.players.forEach(p=>p.pop = Math.max(1,p.pop-1)); toast('–≠–ø–∏–¥–µ–º–∏—è ‚Äî –Ω–∞—Å–µ–ª–µ–Ω–∏–µ —Å–Ω–∏–∑–∏–ª–æ—Å—å') } else { state.players.forEach(p=>p.army += 5); toast('–£—Å–ø–µ—Ö –≤ –±–æ—é ‚Äî –∞—Ä–º–∏—è –≤—ã—Ä–æ—Å–ª–∞') } if(storage && currentUser) saveStateCloud(); else saveStateLocal() }

    // ---------- Export / Import ----------
    function exportData(){ const data = JSON.stringify(state, null, 2); const blob = new Blob([data],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='nova_zemlya_data.json'; a.click(); URL.revokeObjectURL(url); }
    document.getElementById('importFile').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=async ()=>{ try{ const obj=JSON.parse(r.result); if(obj && obj.players){ state=obj; if(storage && currentUser) await saveStateCloud(); else saveStateLocal(); toast('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã'); } else toast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–∞–π–ª'); }catch(err){ toast('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞') } }; r.readAsText(f); e.target.value='' })

    // ---------- Admin helpers ----------
    function addDemoPlayer(){ if(!canEdit()) return toast('–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –ê–¥–º–∏–Ω/–í–ª–∞–¥–µ–ª–µ—Ü'); const id=Date.now(); state.players.push({id,name:'–ù–æ–≤—ã–π_'+id%1000,army:0,pop:5,territories:0,happy:50,energy:50}); if(storage && currentUser) saveStateCloud(); else saveStateLocal(); }

    // ---------- Misc UI ----------
    function showSection(name){ document.querySelectorAll('[id^="section-"]').forEach(el=>el.hidden=true); const el=document.getElementById('section-'+name); if(el) el.hidden=false; if(name==='map') renderMap(); }
    function scrollTo(sel){ const el=document.querySelector(sel); if(el) el.scrollIntoView({behavior:'smooth'}) }
    function toggleAccordion(head){ const body=head.nextElementSibling; if(body.style.display==='block') body.style.display='none'; else body.style.display='block' }

    // ---------- Startup ----------
    // If firebase enabled and logged in, state loaded in onAuthStateChanged
    if(!(storage && currentUser)){
      renderAll()
    }

    // expose for debugging
    window.state = state; window.saveStateLocal = saveStateLocal; window.saveStateCloud = saveStateCloud; window.canEdit = canEdit

  </script>
</body>
</html>
